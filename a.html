<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | EventHub</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --accent: #ec4899;
        --bg-dark: #0f172a;
        --bg-body: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --bg-sidebar: rgba(15, 23, 42, 0.95);
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --success: #10b981;
        --danger: #ef4444;
        --glass: blur(12px);
        --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }
      body {
        background-color: var(--bg-body);
        color: var(--text-main);
        min-height: 100vh;
        display: flex;
        background-image:
          radial-gradient(
            circle at 10% 20%,
            rgba(99, 102, 241, 0.05) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(236, 72, 153, 0.05) 0%,
            transparent 40%
          );
      }

      /* --- Layout --- */
      .dashboard-layout {
        display: flex;
        width: 100%;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 260px;
        background: var(--bg-sidebar);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 20px;
        position: fixed;
        height: 100vh;
        z-index: 100;
        transition: transform 0.3s ease;
      }
      .sidebar-logo {
        font-size: 1.4rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 40px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .nav-menu {
        list-style: none;
      }
      .nav-item {
        padding: 12px 16px;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 8px;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        font-weight: 500;
      }
      .nav-item i {
        font-size: 1.2rem;
      }
      .nav-item:hover,
      .nav-item.active {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
      }

      /* Main Content */
      .main-content {
        flex: 1;
        margin-left: 260px;
        padding: 30px;
        background-color: var(--bg-body);
      }
      .main-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .main-header h1 {
        font-size: 1.8rem;
        margin-bottom: 4px;
      }
      .main-header small {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      /* Cards & Stats */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: var(--bg-card);
        backdrop-filter: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        position: relative;
        overflow: hidden;
      }
      .stat-card h3 {
        color: var(--text-muted);
        font-size: 0.85rem;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: white;
      }
      .stat-card i {
        position: absolute;
        bottom: -10px;
        right: -10px;
        font-size: 6rem;
        opacity: 0.05;
        color: var(--primary);
      }
      .stat-card.profit {
        border-left: 4px solid var(--success);
      }
      .stat-card.profit .value {
        color: var(--success);
      }

      /* Section Card */
      .section-card {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 30px;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }
      .section-header h3 {
        font-size: 1.1rem;
      }

      /* Buttons */
      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.85rem;
        transition: all 0.2s;
      }
      .btn-primary {
        background: var(--gradient);
        color: white;
      }
      .btn-danger {
        background: rgba(239, 68, 68, 0.15);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.2);
      }
      .btn-success {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.2);
      }
      .btn-sm {
        padding: 5px 10px;
        font-size: 0.75rem;
      }

      /* Tables */
      .table-wrapper {
        overflow-x: auto;
        width: 100%;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
      }
      th,
      td {
        text-align: left;
        padding: 14px 16px;
        border-bottom: 1px solid var(--border);
        font-size: 0.9rem;
      }
      th {
        color: var(--text-muted);
        font-weight: 500;
        background: rgba(0, 0, 0, 0.2);
      }
      tr:hover {
        background: rgba(255, 255, 255, 0.02);
      }
      .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      /* Chat Widget */
      .chat-widget {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1000;
      }
      .chat-toggle-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--gradient);
        color: white;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        position: relative;
        border: none;
      }
      .unread-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        background: var(--danger);
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--bg-dark);
      }
      .chat-window {
        position: absolute;
        bottom: 75px;
        right: 0;
        width: 350px;
        height: 480px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 16px;
        display: none;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      }
      .chat-window.open {
        display: flex;
      }
      .chat-header {
        padding: 16px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .chat-header h3 {
        font-size: 1rem;
        flex: 1;
      }
      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .chat-msg {
        max-width: 80%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 0.9rem;
        line-height: 1.4;
        position: relative;
      }
      .chat-msg.sent {
        align-self: flex-end;
        background: var(--primary);
        border-bottom-right-radius: 2px;
      }
      .chat-msg.received {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.1);
        border-bottom-left-radius: 2px;
      }
      .chat-msg small {
        display: block;
        font-size: 0.65rem;
        opacity: 0.7;
        margin-top: 4px;
        text-align: right;
      }
      .chat-footer {
        padding: 12px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
      }
      .chat-input {
        flex: 1;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 0.9rem;
      }
      .chat-input:focus {
        outline: none;
        border-color: var(--primary);
      }

      .chat-user-item {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .chat-user-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .chat-user-item .name {
        font-weight: 600;
        font-size: 0.95rem;
      }
      .chat-user-item .preview {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      /* Login Overlay */
      .login-overlay {
        position: fixed;
        inset: 0;
        background: var(--bg-dark);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .login-box {
        width: 100%;
        max-width: 400px;
        padding: 40px;
        background: var(--bg-card);
        border-radius: 20px;
        border: 1px solid var(--border);
      }
      .login-title {
        text-align: center;
        margin-bottom: 30px;
        font-size: 1.5rem;
      }
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      input {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
      }
      input:focus {
        outline: none;
        border-color: var(--primary);
      }
      /* Modal Overlay Base (Fix for visibility issue) */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.open {
        display: flex; /* Visible only when 'open' class is added */
      }

      /* Toast */
      #toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 3000;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .toast {
        background: rgba(30, 41, 59, 0.95);
        border-left: 4px solid var(--danger);
        padding: 14px 20px;
        border-radius: 8px;
        color: white;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        animation: slideIn 0.3s ease;
      }
      .toast.success {
        border-left-color: var(--success);
      }
      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          z-index: 1001;
        }
        .sidebar.open {
          transform: translateX(0);
        }
        .main-content {
          margin-left: 0;
          padding: 20px;
        }
        .mobile-header {
          display: flex !important;
        }
        .chat-window {
          width: 100%;
          right: -20px;
          bottom: 70px;
        }
      }
      .mobile-header {
        display: none;
        position: sticky;
        top: 0;
        background: var(--bg-dark);
        padding: 15px;
        border-bottom: 1px solid var(--border);
        z-index: 99;
        justify-content: space-between;
        align-items: center;
      }
      /* Custom Confirm Modal Styles */
      .confirm-modal .modal {
        max-width: 400px;
        text-align: center;
        padding: 30px;
        background: var(--bg-card); /* Added background */
        border: 1px solid var(--border); /* Added border */
        border-radius: 16px; /* Added radius */
      }
      .confirm-modal .modal i {
        font-size: 3.5rem;
        margin-bottom: 16px;
        display: block;
      }
      .confirm-modal .modal h2 {
        margin-bottom: 8px;
        font-size: 1.2rem;
      }
      .confirm-modal .modal p {
        color: var(--text-muted);
        margin-bottom: 24px;
        font-size: 0.9rem;
      }
      .confirm-modal .btn-group {
        display: flex;
        gap: 10px;
      }
      .confirm-modal .btn-group .btn {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <!-- Login Overlay -->
    <div id="loginGate" class="login-overlay">
      <div class="login-box">
        <h2 class="login-title">Admin Access</h2>
        <form onsubmit="app.auth.login(event)">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="adminUser" placeholder="admin" required />
          </div>
          <div class="form-group">
            <label>Password</label>
            <input
              type="password"
              id="adminPass"
              placeholder="admin"
              required
            />
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center; margin-top: 10px"
          >
            Enter Dashboard
          </button>
        </form>
      </div>
    </div>

    <!-- Dashboard Layout -->
    <div class="dashboard-layout">
      <!-- Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo"><i class="ph ph-ticket"></i> EventHub</div>
        <ul class="nav-menu">
          <li class="nav-item active" onclick="app.ui.scrollToSection('stats')">
            <i class="ph ph-chart-bar"></i> Overview
          </li>
          <li class="nav-item" onclick="app.ui.scrollToSection('payouts')">
            <i class="ph ph-wallet"></i> Payouts
          </li>
          <li class="nav-item" onclick="app.ui.scrollToSection('events')">
            <i class="ph ph-calendar-blank"></i> Events
          </li>
          <li class="nav-item" onclick="app.ui.scrollToSection('users')">
            <i class="ph ph-users"></i> Users
          </li>
          <li
            class="nav-item"
            onclick="app.chat.toggleWindow()"
            style="color: var(--primary)"
          >
            <i class="ph ph-chat-circle-dots"></i> Support Chat
          </li>
          <li
            class="nav-item"
            style="margin-top: auto; color: var(--danger)"
            onclick="app.auth.logout()"
          >
            <i class="ph ph-sign-out"></i> Logout
          </li>
        </ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Mobile Header -->
        <div class="mobile-header">
          <button onclick="app.ui.toggleSidebar()">
            <i class="ph ph-list" style="font-size: 1.5rem"></i>
          </button>
          <h3 style="font-weight: 600">Admin</h3>
          <div style="width: 30px"></div>
        </div>

        <div class="main-header">
          <div>
            <h1>Dashboard Overview</h1>
            <small>Platform performance summary</small>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid" id="stats">
          <!-- Row 1: Financials -->
          <div class="stat-card">
            <h3>Total Revenue</h3>
            <div class="value" id="globRev">₦0</div>
            <i class="ph ph-currency-circle-dollar"></i>
          </div>
          <div class="stat-card profit">
            <h3>Platform Profit</h3>
            <div class="value" id="globProfit">₦0</div>
            <i class="ph ph-trend-up"></i>
          </div>
          <div class="stat-card" style="border-left: 4px solid var(--success)">
            <h3>Total Paid Out</h3>
            <div class="value" id="globPaidOut" style="color: var(--success)">
              ₦0
            </div>
            <i class="ph ph-money"></i>
          </div>
          <div class="stat-card" style="border-left: 4px solid #f59e0b">
            <h3>Pending Payouts</h3>
            <div class="value" id="globPendingPayouts" style="color: #f59e0b">
              ₦0
            </div>
            <i class="ph ph-hourglass-medium"></i>
          </div>

          <!-- Row 2: Users & Stats -->
          <div class="stat-card">
            <h3>Total Tickets</h3>
            <div class="value" id="globTickets">0</div>
            <i class="ph ph-ticket"></i>
          </div>
          <div class="stat-card">
            <h3>Total Users</h3>
            <div class="value" id="globUsers">0</div>
            <i class="ph ph-users-three"></i>
          </div>
          <div class="stat-card" style="border-left: 4px solid var(--accent)">
            <h3>Total Organizers</h3>
            <div class="value" id="globOrganizers" style="color: var(--accent)">
              0
            </div>
            <i class="ph ph-user-circle-plus"></i>
          </div>
          <div class="stat-card">
            <h3>Total Attendees</h3>
            <div class="value" id="globAttendees">0</div>
            <i class="ph ph-users"></i>
          </div>
        </div>

        <!-- Payouts Section -->
        <div class="section-card" id="payouts">
          <div class="section-header">
            <h3>Payout Requests</h3>
            <small style="color: var(--text-muted)">Pending approvals</small>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Organizer</th>
                  <th>Bank</th>
                  <th>Account</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="withdrawalsTableBody">
                <tr>
                  <td
                    colspan="6"
                    style="
                      text-align: center;
                      padding: 30px;
                      color: var(--text-muted);
                    "
                  >
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Events Section -->
        <div class="section-card" id="events">
          <div class="section-header">
            <h3>All Events</h3>
            <small style="color: var(--text-muted)"
              >Manage platform content</small
            >
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Organizer</th>
                  <th>Sales</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="eventsTable">
                <tr>
                  <td
                    colspan="4"
                    style="
                      text-align: center;
                      padding: 30px;
                      color: var(--text-muted);
                    "
                  >
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Users Section -->
        <div class="section-card" id="users">
          <div class="section-header">
            <h3>User Management</h3>
            <small style="color: var(--text-muted)"
              >Ban or activate accounts</small
            >
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <tr>
                  <td
                    colspan="5"
                    style="
                      text-align: center;
                      padding: 30px;
                      color: var(--text-muted);
                    "
                  >
                    Loading...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <!-- CHAT WIDGET -->
    <div class="chat-widget">
      <div class="chat-window" id="chatWindow">
        <div class="chat-header">
          <i class="ph ph-chat-circle-dots" style="font-size: 1.5rem"></i>
          <h3 id="chatTitle">Messages</h3>
          <button
            onclick="app.chat.toggleWindow()"
            style="background: none; color: var(--text-muted); padding: 0"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-footer" id="chatFooter" style="display: none">
          <textarea
            class="chat-input"
            id="chatInput"
            placeholder="Type a message..."
            rows="1"
            onkeydown="
              if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                app.chat.sendMessage();
              }
            "
          ></textarea>
          <button
            class="btn btn-primary"
            style="padding: 10px 12px; height: 40px; align-self: flex-end"
            onclick="app.chat.sendMessage()"
          >
            <i class="ph ph-paper-plane-tilt"></i>
          </button>
        </div>
      </div>
      <button class="chat-toggle-btn" onclick="app.chat.toggleWindow()">
        <i class="ph ph-chat-dots"></i>
        <span class="unread-badge" id="adminChatBadge">0</span>
      </button>
    </div>

    <div id="toast-container"></div>
    <!-- CUSTOM CONFIRM MODAL -->
    <div class="modal-overlay confirm-modal" id="confirmModal">
      <div class="modal">
        <i
          id="confirmIcon"
          class="ph ph-warning"
          style="color: var(--danger)"
        ></i>
        <h2 id="confirmTitle">Are you sure?</h2>
        <p id="confirmMsg">This action cannot be undone.</p>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="app.ui.closeConfirm()">
            Cancel
          </button>
          <button class="btn btn-danger" id="confirmBtn">Yes, Proceed</button>
        </div>
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxKNu9aoU1uMfdci1jAnMf2wA1nvyyXUNIg8frXxkPb_mPHWqKhbnQVJCyM57n9vlyItA/exec";
      const fmtMoney = (amount) => {
        const num = parseFloat(amount) || 0;
        return "₦" + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };

      const app = {
        platformFee: 0.05,
        init: () => {
          if (localStorage.getItem("eh_admin_session")) {
            document.getElementById("loginGate").style.display = "none";
            document.querySelector(".dashboard-layout").style.display = "flex";
            app.ui.loadDashboard();
          } else {
            document.querySelector(".dashboard-layout").style.display = "none";
            document.getElementById("loginGate").style.display = "flex";
          }
        },

        api: async (action, data = {}) => {
          try {
            const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify({ action, ...data }),
            });
            return await response.json();
          } catch (err) {
            console.error("API Error", err);
            app.ui.toast("Connection Error", "error");
            return { status: "error", message: "Network Error" };
          }
        },

        ui: {
          loadDashboard: async () => {
            // 1. Stats
            const statsRes = await app.api("getAdminStats");
            if (statsRes.status === "success") {
              const s = statsRes.data;

              // Financials
              document.getElementById("globRev").innerText = fmtMoney(
                s.totalRevenue,
              );
              document.getElementById("globProfit").innerText = fmtMoney(
                s.platformProfit,
              );
              document.getElementById("globPaidOut").innerText = fmtMoney(
                s.paidOut,
              );
              document.getElementById("globPendingPayouts").innerText =
                fmtMoney(s.pendingPayouts);

              // Stats
              document.getElementById("globTickets").innerText = s.totalTickets;
              document.getElementById("globUsers").innerText = s.totalUsers;
              document.getElementById("globOrganizers").innerText =
                s.totalOrganizers;
              document.getElementById("globAttendees").innerText =
                s.totalAttendees;
            }

            // 2. Users
            const uRes = await app.api("getAllUsers");
            let usersData = [];
            if (uRes.status === "success") {
              usersData = uRes.data;
              document.getElementById("usersTable").innerHTML = usersData
                .map((u) => {
                  const isBanned = !!u.banned;
                  return `<tr>
                  <td>${u.name}</td><td>${u.email}</td>
                  <td><span class="badge" style="background:${u.role === "organizer" ? "rgba(99,102,241,0.2); color:#818cf8" : "rgba(255,255,255,0.1); color:var(--text-muted)"}">${u.role}</span></td>
                  <td><span class="badge" style="background:${isBanned ? "rgba(239, 68, 68, 0.2); color:var(--danger)" : "rgba(16, 185, 129, 0.2); color:var(--success)"}">${isBanned ? "Banned" : "Active"}</span></td>
                  <td><button class="btn ${isBanned ? "btn-success" : "btn-danger"} btn-sm" onclick="app.handlers.toggleBan('${u.id}', ${!isBanned})">${isBanned ? "Unban" : "Ban"}</button></td>
                </tr>`;
                })
                .join("");
            }

            // 3. Events
            const eRes = await app.api("getEvents");
            if (eRes.status === "success") {
              document.getElementById("eventsTable").innerHTML = eRes.data
                .map((e) => {
                  let eventSales = 0;
                  if (e.tickets)
                    eventSales = e.tickets.reduce(
                      (acc, t) => acc + t.price * t.sold,
                      0,
                    );
                  const gross = eventSales * (1 + app.platformFee);
                  return `<tr>
                  <td>${e.title}</td>
                  <td style="color:var(--text-muted);">${e.organizerId || "Unknown"}</td>
                  <td>${fmtMoney(gross)}</td>
                  <td><button class="btn btn-danger btn-sm" onclick="app.handlers.deleteEvent('${e.id}')">Delete</button></td>
                </tr>`;
                })
                .join("");
            }

            // 4. Withdrawals
            const wRes = await app.api("getAllWithdrawals");
            const wTable = document.getElementById("withdrawalsTableBody");
            if (wRes.status === "success" && wRes.data.length > 0) {
              wTable.innerHTML = wRes.data
                .map((w) => {
                  const org = usersData.find(
                    (u) =>
                      u.id === w.organizerId || u.user_id === w.organizerId,
                  );
                  const orgName = org
                    ? org.name
                    : `<span style="color:var(--danger)">ID: ${w.organizerId}</span>`;
                  return `<tr>
                  <td>${orgName}</td><td>${w.bankName || "-"}</td>
                  <td><button class="masked-acct-btn" onclick="app.ui.toggleDetails('${w.id}')">**** ${w.accountNum ? w.accountNum.slice(-4) : "****"}</button></td>
                  <td style="font-weight:600">${fmtMoney(w.amount)}</td>
                  <td><span class="badge" style="background:${w.status === "Approved" ? "rgba(16, 185, 129, 0.2); color:var(--success)" : "rgba(255,255,255,0.1); color:var(--text-muted)"}">${w.status}</span></td>
                  <td>${w.status !== "Approved" ? `<button class="btn btn-success btn-sm" onclick="app.handlers.approveWithdrawal('${w.id}')">Approve</button>` : `<span style="color:var(--success)">Paid</span>`}</td>
                </tr>
                <tr class="details-row" id="details-${w.id}"><td colspan="6" style="color:var(--text-muted); padding-left:12px;"><strong>Full Details:</strong><br><span style="color:white">${w.accountNum}</span></td></tr>`;
                })
                .join("");
            } else {
              wTable.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:var(--text-muted)">No requests</td></tr>`;
            }

            // Start checking unread messages
            app.chat.startBadgePolling();
          },

          toggleDetails: (id) => {
            const row = document.getElementById(`details-${id}`);
            document
              .querySelectorAll(".details-row.visible")
              .forEach((el) => el.classList.remove("visible"));
            if (row) row.classList.add("visible");
          },

          toggleSidebar: () =>
            document.getElementById("sidebar").classList.toggle("open"),
          scrollToSection: (id) => {
            document.getElementById(id).scrollIntoView({ behavior: "smooth" });
            document.getElementById("sidebar").classList.remove("open");
          },
          toast: (msg, type = "info") => {
            const c = document.getElementById("toast-container");
            const t = document.createElement("div");
            t.className = `toast ${type === "error" ? "" : "success"}`;
            t.innerHTML = `<i class="ph ${type === "error" ? "ph-warning" : "ph-check-circle"}"></i> ${msg}`;
            c.appendChild(t);
            setTimeout(() => t.remove(), 3000);
          },
          // Custom Confirm Modal Logic
          confirm: (title, msg, onConfirm, type = "danger") => {
            document.getElementById("confirmTitle").innerText = title;
            document.getElementById("confirmMsg").innerText = msg;

            // Set icon and button color based on type
            const icon = document.getElementById("confirmIcon");
            const btn = document.getElementById("confirmBtn");

            if (type === "danger") {
              icon.className = "ph ph-warning";
              icon.style.color = "var(--danger)";
              btn.className = "btn btn-danger";
            } else {
              icon.className = "ph ph-check-circle";
              icon.style.color = "var(--success)";
              btn.className = "btn btn-success";
            }

            // Clone button to remove old event listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            // Add new click listener
            newBtn.addEventListener("click", () => {
              onConfirm();
              app.ui.closeConfirm();
            });

            document.getElementById("confirmModal").classList.add("open");
          },
          closeConfirm: () => {
            document.getElementById("confirmModal").classList.remove("open");
          },
        },

        handlers: {
          approveWithdrawal: async (id) => {
            app.ui.confirm(
              "Approve Payout",
              "Mark this request as paid? This cannot be undone.",
              async () => {
                const res = await app.api("approveWithdrawalAction", {
                  withdrawalId: id,
                });
                if (res.status === "success") {
                  app.ui.toast("Approved Successfully");
                  app.ui.loadDashboard();
                } else app.ui.toast(res.message, "error");
              },
            );
          },
          deleteEvent: async (id) => {
            app.ui.confirm(
              "Delete Event",
              "Are you sure you want to permanently delete this event?",
              async () => {
                const res = await app.api("deleteEvent", { eventId: id });
                if (res.status === "success") {
                  app.ui.toast("Event Deleted");
                  app.ui.loadDashboard();
                } else app.ui.toast(res.message, "error");
              },
            );
          },
          toggleBan: async (id, status) => {
            const actionText = status ? "Ban User" : "Unban User";
            const msgText = status
              ? "This user will be blocked from accessing the platform."
              : "This user will regain access to the platform.";

            app.ui.confirm(
              actionText,
              msgText,
              async () => {
                const res = await app.api("updateUserBanAction", {
                  userId: id,
                  banned: status,
                });
                if (res.status === "success") {
                  app.ui.toast("Status Updated");
                  app.ui.loadDashboard();
                } else app.ui.toast(res.message, "error");
              },
              status ? "danger" : "success",
            ); // Pass type to change button color
          },
        },

        auth: {
          login: (e) => {
            e.preventDefault();
            const u = document.getElementById("adminUser").value;
            const p = document.getElementById("adminPass").value;
            if (u === "admin" && p === "admin") {
              localStorage.setItem("eh_admin_session", "true");
              app.init(); // Re-run init to show dashboard
            } else app.ui.toast("Invalid Credentials", "error");
          },
          logout: () => {
            localStorage.removeItem("eh_admin_session");
            window.location.reload();
          },
        },

        // ==========================================
        // CHAT SYSTEM MODULE
        // ==========================================
        chat: {
          isAdmin: true,
          adminId: "ADMIN_PLATFORM",
          currentRecipient: null,
          pollInterval: null,
          badgeInterval: null,

          toggleWindow: async function () {
            const win = document.getElementById("chatWindow");
            const isNowOpen = !win.classList.contains("open");
            win.classList.toggle("open");

            if (isNowOpen) {
              document.getElementById("adminChatBadge").style.display = "none";
              await this.loadChatList();
              if (!this.pollInterval)
                this.pollInterval = setInterval(
                  () => this.refreshMessages(),
                  3000,
                );
              if (this.badgeInterval) {
                clearInterval(this.badgeInterval);
                this.badgeInterval = null;
              }
            } else {
              if (this.pollInterval) {
                clearInterval(this.pollInterval);
                this.pollInterval = null;
              }
              this.startBadgePolling();
            }
          },

          checkUnread: async function () {
            if (
              document.getElementById("chatWindow").classList.contains("open")
            )
              return;
            const res = await app.api("getUnreadCount", {
              userId: this.adminId,
            });
            if (res.status === "success" && res.count > 0) {
              const badge = document.getElementById("adminChatBadge");
              badge.innerText = res.count > 9 ? "9+" : res.count;
              badge.style.display = "flex";
            } else {
              document.getElementById("adminChatBadge").style.display = "none";
            }
          },

          startBadgePolling: function () {
            this.checkUnread();
            if (!this.badgeInterval) {
              this.badgeInterval = setInterval(() => this.checkUnread(), 5000);
            }
          },

          loadChatList: async function () {
            document.getElementById("chatTitle").innerText = "Messages";
            document.getElementById("chatFooter").style.display = "none";
            document.getElementById("chatBody").innerHTML =
              `<div style="text-align:center; padding:20px; color:var(--text-muted)">Loading...</div>`;
            const res = await app.api("getChatList", {
              role: "admin",
              includeAll: true,
            });
            if (res.status === "success" && res.data.length > 0) {
              document.getElementById("chatBody").innerHTML = res.data
                .map(
                  (u) => `
                <div class="chat-user-item" onclick="app.chat.openChat('${u.id}', '${u.name.replace(/'/g, "\\'")}')">
                  <div>
                    <div class="name">${u.name}</div>
                    <div class="preview">${u.lastMessage || "Click to chat"}</div>
                  </div>
                  <i class="ph ph-caret-right" style="color:var(--text-muted)"></i>
                </div>
              `,
                )
                .join("");
            } else {
              document.getElementById("chatBody").innerHTML =
                `<div style="text-align:center; padding:20px; color:var(--text-muted)">No users found.</div>`;
            }
          },

          openChat: async function (recipientId, recipientName) {
            this.currentRecipient = recipientId;
            document.getElementById("chatTitle").innerText = recipientName;
            document.getElementById("chatBody").innerHTML =
              `<div style="text-align:center; padding:20px; color:var(--text-muted)">Loading chat...</div>`;
            document.getElementById("chatFooter").style.display = "flex";
            await this.refreshMessages();
          },

          refreshMessages: async function () {
            if (!this.currentRecipient) return;
            const res = await app.api("getMessages", {
              userId: this.adminId,
              otherId: this.currentRecipient,
            });
            if (res.status === "success") {
              const html = res.data
                .map((m) => {
                  const isSent = m.sender_id === this.adminId;
                  const time = new Date(m.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  });
                  return `<div class="chat-msg ${isSent ? "sent" : "received"}">${m.message_text}<small>${time}</small></div>`;
                })
                .join("");
              const body = document.getElementById("chatBody");
              body.innerHTML =
                html ||
                `<div style="text-align:center; padding:20px; color:var(--text-muted)">Say hello!</div>`;
              if (body.scrollHeight > prevScroll)
                body.scrollTop = body.scrollHeight;
            }
          },

          sendMessage: async function () {
            const input = document.getElementById("chatInput");
            const msg = input.value.trim();
            if (!msg || !this.currentRecipient) return;
            input.value = "";
            input.style.height = "auto";
            await app.api("sendMessage", {
              senderId: this.adminId,
              senderName: "Admin",
              receiverId: this.currentRecipient,
              message: msg,
            });
            await this.refreshMessages();
          },
        },
      };
      document.addEventListener("DOMContentLoaded", app.init);
    </script>
  </body>
</html>

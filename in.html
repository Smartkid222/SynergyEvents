<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>21EventHub - Optimized Platform</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --accent: #ec4899;
        --bg-dark: #0f172a;
        --bg-card: rgba(30, 41, 59, 0.7);
        --text-main: #f8fafc;
        --text-muted: #94a3b8;
        --border: rgba(255, 255, 255, 0.1);
        --success: #10b981;
        --danger: #ef4444;
        --glass: blur(12px);
        --shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        --gradient: linear-gradient(135deg, #6366f1 0%, #ec4899 100%);
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        background-color: var(--bg-dark);
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 80px;
        background-image:
          radial-gradient(
            circle at 10% 20%,
            rgba(99, 102, 241, 0.15) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 90% 80%,
            rgba(236, 72, 153, 0.15) 0%,
            transparent 40%
          );
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }
      button {
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.95rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        text-decoration: none;
      }
      .btn-primary {
        background: var(--gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
      }
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }
      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        background: #475569;
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        color: var(--text-main);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .btn-danger {
        background: rgba(239, 68, 68, 0.2);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.3);
      }
      .btn-success {
        background: rgba(16, 185, 129, 0.2);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .page-loader {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 40px;
        width: 100%;
        min-height: 200px;
      }
      .card {
        background: var(--bg-card);
        backdrop-filter: var(--glass);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        box-shadow: var(--shadow);
        margin-bottom: 24px;
      }
      .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }
      .badge-cat {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
      }
      .logo {
        font-size: 1.5rem;
        font-weight: 800;
        background: var(--gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        letter-spacing: -1px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid var(--border);
        padding: 16px 0;
      }
      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .nav-actions {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      /* --- CHAT WIDGET --- */
      .chat-widget {
        position: fixed;
        bottom: 90px;
        right: 20px;
        z-index: 100;
      }
      .chat-toggle-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: var(--gradient);
        color: white;
        font-size: 1.6rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
      }
      /* RED BADGE STYLES */
      .unread-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        min-width: 20px;
        height: 20px;
        padding: 0 4px; /* Padding for numbers like '10' */
        background: #ef4444; /* Red color */
        color: white;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 700;
        display: none;
        align-items: center;
        justify-content: center;
        border: 2px solid var(--bg-dark);
        z-index: 10;
      }
      .chat-window {
        position: absolute;
        bottom: 70px;
        right: 0;
        width: 320px;
        height: 450px;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 16px;
        display: none;
        flex-direction: column;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
      }
      .chat-window.open {
        display: flex;
      }
      .chat-header {
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .chat-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .chat-msg {
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
      }
      .chat-msg.sent {
        align-self: flex-end;
        background: var(--primary);
        border-bottom-right-radius: 2px;
      }
      .chat-msg.received {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.08);
        border-bottom-left-radius: 2px;
      }
      .chat-footer {
        padding: 10px;
        border-top: 1px solid var(--border);
        display: flex;
        gap: 8px;
      }
      .chat-input {
        flex: 1;
        padding: 8px;
        margin: 0;
        font-size: 0.9rem;
      }

      .view {
        display: none;
        padding: 40px 0;
        animation: fadeIn 0.4s ease;
      }
      .view.active {
        display: block;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Mobile Header Profile Icon */
      .mobile-header-profile {
        display: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: var(--gradient);
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border: 2px solid var(--border);
      }
      .mobile-header-profile img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* Forms */
      .form-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
      }

      /* Event Cards - Improved UI */
      .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 24px;
      }

      .event-card {
        overflow: hidden;
        display: flex;
        flex-direction: column;
        transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        cursor: pointer;
        border: 1px solid var(--border);
        border-radius: 20px;
        position: relative;
        background: var(--bg-card);
        backdrop-filter: blur(8px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
      }

      .event-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 50px -15px rgba(99, 102, 241, 0.35);
        border-color: rgba(99, 102, 241, 0.4);
      }

      .event-img {
        aspect-ratio: 3 / 2; /* or 5/3, 4/3 — experiment */
        height: auto;
        max-height: 220px;
      }

      .event-img img {
        /* ← we'll switch to <img> for better quality control */
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* Optional gradient overlay – less aggressive than before */
      .event-img::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(
          to bottom,
          transparent 30%,
          rgba(15, 23, 42, 0.75) 80%
        );
        pointer-events: none;
      }

      .event-card-content {
        padding: 20px 20px 24px;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        gap: 10px;
      }

      .event-card-title {
        font-size: 1.28rem;
        font-weight: 700;
        line-height: 1.32;
        margin: 0 0 6px 0;
        color: white;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .event-card-meta {
        font-size: 0.88rem;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .event-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: auto;
        padding-top: 16px;
        border-top: 1px solid var(--border);
      }

      .event-price {
        font-weight: 800;
        font-size: 1.32rem;
        color: var(--primary);
        letter-spacing: -0.5px;
      }

      /* External event styling */
      .event-card.external-only .event-price {
        color: #a5b4fc;
        font-style: italic;
        font-weight: 600;
      }

      .event-card.external-only .event-card-footer .btn-primary {
        background: linear-gradient(135deg, #7c3aed, #c084fc);
        box-shadow: 0 4px 14px rgba(124, 58, 237, 0.35);
      }

      .event-card.external-only .event-card-footer .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(124, 58, 237, 0.45);
      }
      .qty-control {
        display: flex;
        align-items: center;
        gap: 12px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px;
        border-radius: 8px;
      }
      .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2rem;
      }
      .qty-btn:hover:not(:disabled) {
        background: var(--primary);
      }
      .qty-value {
        min-width: 24px;
        text-align: center;
        font-weight: 600;
      }

      /* Favorite Heart */
      .fav-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(4px);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        color: white;
        font-size: 1.1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }
      .fav-btn:hover {
        transform: scale(1.15);
        background: white;
        color: #ef4444;
      }
      .fav-btn.active {
        background: white;
        color: #ef4444;
        border-color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      }
      .fav-btn.active i {
        font-weight: 900;
      }

      /* Popular Events */
      .popular-section {
        margin-bottom: 40px;
      }
      .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .section-title i {
        color: var(--accent);
      }
      .popular-scroll {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 16px;
        scroll-snap-type: x mandatory;
      }
      .popular-scroll::-webkit-scrollbar {
        display: none;
      }
      .popular-card {
        min-width: 280px;
        scroll-snap-align: start;
        background: var(--bg-card);
        border-radius: 20px;
        overflow: hidden;
        border: 1px solid var(--border);
        position: relative;
      }
      .popular-card img {
        width: 100%;
        height: 140px;
        object-fit: cover;
      }
      .popular-info {
        padding: 16px;
      }
      .popular-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: var(--gradient);
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 700;
      }
      .pill {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        width: 50px;
        height: 50px;
        padding: 0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 1.2rem;
        color: var(--text-muted);
      }
      .pill:hover,
      .pill.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      }

      /* Detail View - Updated for Side-by-Side Desktop Layout */
      .detail-header {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .detail-img {
        width: 100%;
        height: 300px;
        border-radius: 24px;
        background-size: cover;
        background-position: center;
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      .detail-content {
        width: 100%;
      }

      /* Desktop Layout for Detail View */
      @media (min-width: 769px) {
        .detail-header {
          flex-direction: row;
          align-items: flex-start;
          gap: 40px;
        }
        .detail-img {
          width: 45%;
          height: 500px; /* Taller, clearer image */
          position: sticky;
          top: 100px;
          border-radius: 24px;
        }
        .detail-content {
          width: 55%;
        }
      }

      .detail-top-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .description-box {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        border-left: 4px solid var(--primary);
      }
      .organizer-card {
        display: flex;
        align-items: center;
        gap: 16px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border);
        padding: 16px;
        border-radius: 16px;
        margin-top: 20px;
      }
      .org-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        font-weight: bold;
        overflow: hidden;
      }
      .org-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .ticket-list-container {
        margin-top: 24px;
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.2);
      }
      .ticket-item {
        padding: 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      /* Better modal handling for ticket view */
      #ticketDetailModal .modal {
        width: 95%;
        max-width: 700px;
        margin: 20px auto;
        border-radius: 16px;
      }

      #ticketDetailModal .modal-content {
        padding: 16px;
        background: var(--bg-dark);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .ticket-action-bar {
        display: flex;
        gap: 12px;
        width: 100%;
        max-width: 500px;
        margin-top: 16px;
      }

      .ticket-action-bar .btn {
        flex: 1;
        padding: 12px;
        font-size: 1rem;
      }
      .ticket-visual,
      .ticket-visual * {
        color: #000000 !important; /* Force all text black */
        -webkit-print-color-adjust: exact; /* Helps in some browsers */
        print-color-adjust: exact;
      }

      .ticket-visual .tv-main,
      .ticket-visual .tv-stub {
        color: #000000 !important;
      }

      .ticket-visual h2,
      .ticket-visual h3,
      .ticket-visual .tv-label,
      .ticket-visual .tv-value {
        color: #000000 !important;
      }

      /* Remove any gradient/background that might interfere */
      .ticket-visual {
        background: white !important;
        background-image: none !important;
      }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        #ticketDetailModal .modal {
          width: 98%;
          margin: 10px auto;
          border-radius: 16px 16px 0 0;
        }

        .ticket-visual.ticket-visual-large {
          width: 100% !important;
          max-width: none !important;
        }

        .tv-qr {
          width: 140px;
          height: 140px;
        }

        .ticket-action-bar {
          flex-direction: column;
          gap: 10px;
        }
      }
      .price-breakdown {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 8px;
        margin-top: 20px;
      }
      .price-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.9rem;
        color: var(--text-muted);
      }
      .price-row.total {
        font-weight: 700;
        font-size: 1.2rem;
        color: var(--text-main);
        margin-top: 8px;
        border-top: 1px dashed var(--border);
        padding-top: 8px;
      }

      /* Tables */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        text-align: left;
        padding: 16px;
        border-bottom: 1px solid var(--border);
        white-space: nowrap;
      }
      th {
        color: var(--text-muted);
      }
      .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
        border: 1px solid var(--border);
      }
      table {
        min-width: 800px;
      }

      /* Modals */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal-overlay.open {
        display: flex;
      }
      .modal {
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        background: var(--bg-dark);
        border: 1px solid var(--border);
        border-radius: 24px;
      }

      /* Profile Modal Specific */
      .profile-header {
        text-align: center;
        padding: 30px 20px;
        background: linear-gradient(
          to bottom,
          rgba(99, 102, 241, 0.1),
          transparent
        );
      }
      .profile-avatar-large {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: var(--gradient);
        margin: 0 auto 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        color: white;
        position: relative;
        overflow: hidden;
        cursor: pointer;
      }
      .profile-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .profile-avatar-large .edit-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
      }
      .profile-avatar-large:hover .edit-overlay {
        opacity: 1;
      }
      .profile-menu-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.2s;
      }
      .profile-menu-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .profile-menu-item i {
        font-size: 1.25rem;
        color: var(--text-muted);
        width: 24px;
        text-align: center;
      }
      .profile-menu-item.danger {
        color: var(--danger);
      }
      .profile-menu-item.danger i {
        color: var(--danger);
      }

      /* Ticket Visual Styles */
      .tickets-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
      }
      /* Updated Ticket Styles - More Modern & Responsive */
      .ticket-visual {
        flex-direction: row; /* Side-by-side for larger screens */
        max-width: 800px;
        margin: 0 auto;
      }

      .tv-main {
        flex: 2;
        padding: 32px;
        border-bottom: none;
        border-right: 2px dashed #e2e8f0;
      }

      .tv-stub {
        flex: 1;
        padding: 32px;
      }

      .tv-cutout {
        width: 24px;
        height: 24px;
        top: auto;
        left: 100%;
        transform: translateX(-50%);
      }

      .tv-cutout.left {
        top: -12px;
        left: auto;
        bottom: auto;
        right: 100%;
        transform: translateX(50%);
      }

      .tv-cutout.right {
        bottom: -12px;
        left: auto;
        right: 100%;
        transform: translateX(50%);
      }

      .tv-qr {
        width: 160px;
        height: 160px;
      }

      .tv-title {
        font-size: 1.6rem;
      }

      #ticketForCapture {
        max-width: 600px;
      }
      /* Modal Content Adjustments */
      .modal-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        width: 100%;
        max-width: 90vw; /* Max 90% of viewport width */
        box-sizing: border-box;
      }

      #ticketForCapture {
        width: 100%;
        max-width: 400px; /* Limit max width for larger screens */
        margin-bottom: 20px;
      }

      .ticket-action-bar {
        display: flex;
        gap: 12px;
        width: 100%;
        max-width: 400px;
        justify-content: space-between;
      }

      .ticket-action-bar .btn {
        flex: 1;
      }

      /* User Menu Dropdown */
      .user-menu-container {
        position: relative;
      }
      .user-menu-dropdown {
        position: absolute;
        top: 100%;
        right: 0;
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        min-width: 150px;
        display: none;
        flex-direction: column;
        gap: 4px;
        margin-top: 10px;
        z-index: 200;
        backdrop-filter: blur(20px);
      }
      .user-menu-dropdown.open {
        display: flex;
      }
      .user-menu-item {
        padding: 10px 16px;
        color: var(--text-main);
        cursor: pointer;
        border-radius: 8px;
        text-align: left;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .user-menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .user-menu-item.danger {
        color: var(--danger);
      }

      /* Toast */
      #toast-container {
        position: fixed;
        top: 24px;
        right: 24px;
        z-index: 10000;
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 380px;
      }
      .toast {
        min-width: 320px;
        padding: 16px 20px;
        border-radius: 12px;
        background: rgba(30, 41, 59, 0.96);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        gap: 14px;
        color: white;
        transform: translateX(120%);
        opacity: 0;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      .toast.show {
        transform: translateX(0);
        opacity: 1;
      }

      /* Preloader */
      #preloader {
        position: fixed;
        inset: 0;
        background: var(--bg-dark);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.5s ease;
      }
      .loader-ring {
        width: 64px;
        height: 64px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }

      /* Footer */
      .main-footer {
        text-align: center;
        padding: 40px 20px;
        border-top: 1px solid var(--border);
        margin-top: 40px;
        color: var(--text-muted);
        font-size: 0.9rem;
      }
      .main-footer .brand {
        font-weight: 700;
        color: var(--text-main);
      }

      /* Mobile Nav - Icons Only */
      .mobile-bottom-nav {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--border);
        z-index: 99;
        justify-content: space-around;
        align-items: center;
      }
      .mobile-nav-item {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        cursor: pointer;
        padding: 12px;
        border-radius: 16px;
        transition: all 0.2s;
        width: 60px;
        height: 60px;
      }
      .mobile-nav-item i {
        font-size: 1.6rem;
        margin: 0;
      }
      .mobile-nav-item.active {
        color: var(--primary);
        background: rgba(99, 102, 241, 0.1);
      }

      @media (max-width: 768px) {
        body {
          padding-bottom: 70px;
        }
        .nav-actions {
          display: none !important;
        }
        .mobile-header-profile {
          display: flex;
        }
        nav {
          justify-content: space-between;
        }
        .mobile-bottom-nav {
          display: flex;
        }
        header {
          padding: 10px 0;
        }
        .modal-overlay {
          justify-content: flex-end;
          background: transparent;
        }
        .modal {
          width: 100%;
          max-width: 100%;
          border-radius: 24px 24px 0 0;
          transform: translateY(100%);
          transition: transform 0.3s;
          padding-bottom: 30px;
        }
        .modal-overlay.open .modal {
          transform: translateY(0);
        }
        #toast-container {
          top: 16px;
          right: 16px;
          left: 16px;
          max-width: none;
        }
        .toast {
          min-width: auto;
        }
        .ticket-visual {
          border-radius: 16px; /* Softer corners on mobile */
        }

        .tv-main {
          padding: 20px;
        }

        .tv-stub {
          padding: 16px;
        }

        .tv-qr {
          width: 100px;
          height: 100px;
        }

        .tv-title {
          font-size: 1.2rem;
        }

        .tv-row {
          font-size: 0.9rem;
        }

        .modal-content {
          padding: 16px;
        }

        #ticketForCapture {
          max-width: 100%; /* Full width on mobile */
        }

        .ticket-action-bar {
          flex-direction: column; /* Stack buttons on very small screens */
          gap: 8px;
        }
        .popular-card {
          min-width: 260px;
        }
      }
      /* Hero Section Centered */
      .hero {
        text-align: center;
        padding: 40px 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .search-bar-container {
        position: relative;
        margin-top: 24px;
        width: 100%;
        max-width: 600px;
      }
      .search-bar {
        width: 100%;
        padding: 16px 20px 16px 50px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 16px;
        color: white;
        font-size: 1rem;
      }
      .search-bar:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--primary);
      }
      .search-icon {
        position: absolute;
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1.2rem;
      }
      .category-pills {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        overflow-x: auto;
        padding-bottom: 8px;
        scrollbar-width: none;
        max-width: 600px;
        justify-content: center;
      }
      .category-pills::-webkit-scrollbar {
        display: none;
      }
      .pill {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        padding: 10px 20px;
        border-radius: 12px;
        font-size: 0.9rem;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s;
      }
      .pill:hover,
      .pill.active {
        background: var(--primary);
        border-color: var(--primary);
      }
    </style>
  </head>
  <body>
    <div id="preloader">
      <div class="loader-ring"></div>
      <h2
        style="
          background: var(--gradient);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        "
      >
        21EventHub
      </h2>
    </div>

    <header>
      <div class="container">
        <nav>
          <div class="logo" onclick="app.router.navigate('home')">
            <i class="ph ph-ticket"></i> 21EventHub
          </div>

          <!-- Mobile Profile Icon -->
          <div
            class="mobile-header-profile"
            id="mobileHeaderProfile"
            onclick="app.ui.openProfileModal()"
          >
            <i class="ph ph-user" style="font-size: 1.2rem; color: white"></i>
          </div>

          <div class="nav-actions">
            <button
              class="btn btn-secondary"
              onclick="app.router.navigate('home')"
            >
              Find Events
            </button>
            <button
              class="btn btn-secondary"
              onclick="app.router.navigate('favorites')"
            >
              <i class="ph ph-heart"></i> Favorites
            </button>
            <div id="loggedOutNav" style="display: flex; gap: 10px">
              <div
                class="btn btn-secondary"
                onclick="app.ui.openAuthModal('login')"
              >
                Login
              </div>
              <div
                class="btn btn-primary"
                onclick="app.ui.openAuthModal('signup')"
              >
                Sign Up
              </div>
            </div>
            <div
              id="loggedInNav"
              style="display: none; gap: 10px; align-items: center"
            >
              <span id="userNameDisplay" style="font-weight: 500"></span>
              <button
                class="btn btn-secondary"
                onclick="app.router.navigate('dashboard')"
              >
                My Tickets
              </button>
              <button id="roleBtn" class="btn btn-primary">My Dashboard</button>
              <div class="user-menu-container">
                <button
                  class="btn btn-secondary"
                  style="padding: 8px"
                  onclick="app.ui.toggleUserMenu()"
                  title="Menu"
                >
                  <i class="ph ph-user-circle"></i>
                </button>
                <div id="userMenuDropdown" class="user-menu-dropdown">
                  <div class="user-menu-item" onclick="app.ui.showContactUs()">
                    <i class="ph ph-envelope"></i> Contact Us
                  </div>
                  <div
                    class="user-menu-item danger"
                    onclick="app.auth.logout()"
                  >
                    <i class="ph ph-sign-out"></i> Logout
                  </div>
                </div>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- MOBILE NAV (Icons Only) -->
    <div class="mobile-bottom-nav">
      <div class="mobile-nav-item active" onclick="app.router.navigate('home')">
        <i class="ph ph-house"></i>
      </div>
      <div class="mobile-nav-item" onclick="app.router.navigate('favorites')">
        <i class="ph ph-heart"></i>
      </div>
      <div
        class="mobile-nav-item"
        id="mobileTicketsBtn"
        onclick="app.router.navigate('dashboard')"
      >
        <i class="ph ph-ticket"></i>
      </div>
      <div class="mobile-nav-item" id="mobileDashBtn">
        <i class="ph ph-squares-four"></i>
      </div>
      <div
        class="mobile-nav-item"
        id="mobileProfileBtn"
        onclick="app.ui.openProfileModal()"
      >
        <i class="ph ph-user-circle"></i>
      </div>
    </div>

    <main id="app" class="container"></main>

    <!-- FOOTER -->
    <footer class="main-footer container">
      <div class="brand">© 2026 21EventHub. All rights reserved.</div>
      <div style="margin-top: 4px; font-size: 0.8rem">
        Proudly sponsored by
        <span class="brand" style="color: var(--accent)">21Synergy</span>
      </div>
    </footer>

    <div id="toast-container"></div>

    <!-- AUTH MODAL -->
    <div class="modal-overlay" id="authModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2 id="authTitle">Login</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('authModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form id="authForm" onsubmit="app.auth.handleAuth(event)">
          <div class="form-group">
            <label>Email</label
            ><input
              type="email"
              name="email"
              required
              placeholder="user@example.com"
            />
          </div>
          <div class="form-group">
            <label>Password</label
            ><input
              type="password"
              name="password"
              required
              placeholder="•••••"
            />
          </div>
          <div id="signupFields" style="display: none">
            <div class="form-group">
              <label>Full Name</label
              ><input type="text" name="name" placeholder="John Doe" />
            </div>
            <div class="form-group">
              <label>I am a(n):</label>
              <div style="display: flex; gap: 20px; margin-top: 5px">
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    cursor: pointer;
                    color: var(--text-main);
                  "
                  ><input
                    type="radio"
                    name="role"
                    value="attendee"
                    checked
                    style="width: auto; margin: 0"
                  />
                  Attendee</label
                >
                <label
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    cursor: pointer;
                    color: var(--text-main);
                  "
                  ><input
                    type="radio"
                    name="role"
                    value="organizer"
                    style="width: auto; margin: 0"
                    onchange="app.ui.toggleBrandName(true)"
                  />
                  Organizer</label
                >
              </div>
            </div>
            <div
              class="form-group"
              id="brandNameGroup"
              style="display: none; animation: fadeIn 0.3s ease"
            >
              <label>Brand Name (Optional)</label
              ><input
                type="text"
                name="brandName"
                placeholder="e.g. Studio 54"
              />
            </div>
          </div>
          <button
            type="submit"
            class="btn btn-primary"
            style="width: 100%; justify-content: center"
          >
            Submit
          </button>
        </form>
        <p
          style="
            text-align: center;
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--text-muted);
          "
        >
          <span id="authSwitchText">New here?</span>
          <a
            href="#"
            style="color: var(--primary)"
            onclick="app.ui.toggleAuthMode()"
            >Click here</a
          >
        </p>
      </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div class="modal-overlay" id="checkoutModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Checkout</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('checkoutModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>

        <!-- Order Summary Section -->
        <div
          id="checkoutSummary"
          class="card"
          style="background: rgba(255, 255, 255, 0.03); margin-bottom: 20px"
        >
          <!-- Populated by JS -->
        </div>

        <div style="text-align: center; margin-top: 10px">
          <p
            style="
              font-size: 0.85rem;
              color: var(--text-muted);
              margin-bottom: 15px;
            "
          >
            You will be redirected to a secure payment gateway.
          </p>
          <button
            type="button"
            id="payBtn"
            class="btn btn-primary"
            style="
              width: 100%;
              justify-content: center;
              font-size: 1.1rem;
              padding: 16px;
            "
            onclick="app.handlers.processPayment()"
          >
            Pay <span id="payAmount"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- ORGANIZER CREATE/EDIT MODAL -->
    <div class="modal-overlay" id="eventModal">
      <div class="modal card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2 id="modalTitle">Create Event</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('eventModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form onsubmit="app.handlers.saveEvent(event)">
          <input type="hidden" id="eventIdHidden" />
          <div class="form-group">
            <label>Event Title</label
            ><input type="text" id="eventTitle" required />
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px">
            <div class="form-group">
              <label>Date</label><input type="date" id="eventDate" required />
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="eventCategory">
                <option>Music</option>
                <option>Tech</option>
                <option>Business</option>
                <option>Art</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Location</label
            ><input type="text" id="eventLocation" required />
          </div>
          <div class="form-group">
            <label>Description</label
            ><textarea
              id="eventDescription"
              rows="4"
              placeholder="Describe your event..."
            ></textarea>
          </div>
          <div class="form-group">
            <label>Event Image</label>
            <input
              type="file"
              id="eventImageInput"
              accept="image/*"
              onchange="app.handlers.previewImage(this)"
            />
            <div
              id="imagePreviewContainer"
              style="margin-top: 10px; display: none; position: relative"
            >
              <img
                id="imgPreview"
                src=""
                style="
                  width: 100%;
                  height: 200px;
                  object-fit: cover;
                  border-radius: 8px;
                  border: 1px solid var(--border);
                "
              />
              <button
                type="button"
                onclick="app.handlers.clearImage()"
                style="
                  position: absolute;
                  top: 10px;
                  right: 10px;
                  background: rgba(0, 0, 0, 0.7);
                  color: white;
                  border-radius: 50%;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  cursor: pointer;
                "
              >
                &times;
              </button>
            </div>
          </div>
          <div style="margin-bottom: 16px">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
              "
            >
              <label style="margin: 0">Ticket Types</label>
              <button
                type="button"
                class="btn btn-secondary btn-sm"
                onclick="app.handlers.addTicketRow()"
              >
                <i class="ph ph-plus"></i> Add Type
              </button>
            </div>
            <div id="ticketTypesContainer"></div>
            <div
              style="
                margin-bottom: 16px;
                margin-top: 20px;
                border-top: 1px dashed var(--border);
                padding-top: 15px;
              "
            >
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 10px;
                "
              >
                <label style="margin: 0; font-weight: 600"
                  >Discount Coupons</label
                >
                <button
                  type="button"
                  class="btn btn-secondary btn-sm"
                  onclick="app.handlers.addCouponRow()"
                >
                  <i class="ph ph-plus"></i> Add Coupon
                </button>
              </div>
              <div id="couponContainer"></div>
            </div>
          </div>
          <button
            type="submit"
            id="saveEventBtn"
            class="btn btn-primary"
            style="width: 100%"
          >
            Publish Event
          </button>
        </form>
      </div>
    </div>

    <!-- WITHDRAWAL MODAL -->
    <div class="modal-overlay" id="withdrawalModal">
      <div class="modal card">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2>Request Withdrawal</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('withdrawalModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <form onsubmit="app.handlers.requestWithdrawal(event)">
          <div class="form-group">
            <label>Available to Withdraw (₦)</label
            ><input
              type="number"
              id="withdrawalAmountInput"
              name="amount"
              readonly
              step="0.01"
            />
          </div>
          <div class="form-group">
            <label>Bank Name</label
            ><input
              type="text"
              name="bankName"
              required
              placeholder="e.g. Access Bank"
            />
          </div>
          <div class="form-group">
            <label>Account Number</label
            ><input
              type="text"
              name="accountNum"
              required
              placeholder="Last 4 digits"
            />
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%">
            Submit Request
          </button>
        </form>
      </div>
    </div>

    <!-- TICKET DETAIL MODAL -->
    <!-- Updated Ticket Detail Modal HTML -->
    <div class="modal-overlay" id="ticketDetailModal">
      <div class="modal">
        <div class="modal-content">
          <div
            style="
              width: 100%;
              display: flex;
              justify-content: flex-end;
              margin-bottom: 16px;
            "
          >
            <button
              class="btn btn-secondary btn-sm"
              onclick="app.ui.closeModal('ticketDetailModal')"
            >
              <i class="ph ph-x"></i>
            </button>
          </div>
          <div id="ticketForCapture"></div>
          <div class="ticket-action-bar">
            <button
              class="btn btn-primary"
              onclick="app.handlers.downloadTicket()"
            >
              <i class="ph ph-download-simple"></i> Download
            </button>
            <button
              class="btn btn-success"
              onclick="app.handlers.shareTicket()"
            >
              <i class="ph ph-share-network"></i> Share
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE MODAL -->
    <div class="modal-overlay" id="profileModal">
      <div class="modal" style="padding: 0">
        <div class="profile-header">
          <button
            class="btn btn-secondary"
            style="position: absolute; top: 16px; right: 16px; padding: 6px"
            onclick="app.ui.closeModal('profileModal')"
          >
            <i class="ph ph-x"></i>
          </button>
          <div
            class="profile-avatar-large"
            onclick="app.ui.triggerProfilePicUpload()"
          >
            <img src="" id="profilePicLarge" style="display: none" />
            <i class="ph ph-user" id="profilePicPlaceholder"></i>
            <div class="edit-overlay"><i class="ph ph-camera"></i></div>
          </div>
          <input
            type="file"
            id="profilePicInput"
            accept="image/*"
            style="display: none"
            onchange="app.ui.handleProfilePicChange(this)"
          />
          <h2 id="profileNameDisplay" style="margin-bottom: 4px">Guest</h2>
          <p
            id="profileEmailDisplay"
            style="font-size: 0.9rem; color: var(--text-muted); margin: 0"
          >
            Login to continue
          </p>
        </div>
        <div id="profileMenuContent"></div>
      </div>
    </div>

    <!-- CONTACT US MODAL -->
    <div class="modal-overlay" id="contactModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          "
        >
          <h2>Contact Us</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('contactModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <p style="color: var(--text-muted); margin-bottom: 20px">
          Need help? Reach out to us via email or phone.
        </p>
        <div style="display: flex; flex-direction: column; gap: 15px">
          <a
            href="mailto:support@21events.com"
            style="
              color: white;
              text-decoration: none;
              display: flex;
              align-items: center;
              gap: 10px;
              background: rgba(255, 255, 255, 0.05);
              padding: 15px;
              border-radius: 12px;
            "
          >
            <i
              class="ph ph-envelope"
              style="font-size: 1.5rem; color: var(--primary)"
            ></i>
            <span>support@21events.com</span>
          </a>
          <a
            href="tel:+2348000000000"
            style="
              color: white;
              text-decoration: none;
              display: flex;
              align-items: center;
              gap: 10px;
              background: rgba(255, 255, 255, 0.05);
              padding: 15px;
              border-radius: 12px;
            "
          >
            <i
              class="ph ph-phone"
              style="font-size: 1.5rem; color: var(--primary)"
            ></i>
            <span>+234 800 000 0000</span>
          </a>
        </div>
      </div>
    </div>

    <!-- ABOUT US MODAL -->
    <div class="modal-overlay" id="aboutModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2>About Us</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('aboutModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <p style="color: var(--text-muted); line-height: 1.6">
          Welcome to 21EventHub, your premier destination for discovering and
          managing the best events. We connect people through unforgettable
          experiences. Our platform empowers organizers to reach wider audiences
          and attendees to find their next adventure.
        </p>
        <br />
        <p style="color: var(--text-muted); line-height: 1.6">
          Version 1.0.0<br />
          Built with ❤️ for the community.
        </p>
      </div>
    </div>

    <!-- HELP CENTER MODAL -->
    <div class="modal-overlay" id="helpModal">
      <div class="card modal">
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
          "
        >
          <h2>Help Center</h2>
          <button
            class="btn btn-secondary"
            onclick="app.ui.closeModal('helpModal')"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div style="margin-bottom: 16px">
          <h4 style="margin-bottom: 8px">How to buy a ticket?</h4>
          <p style="color: var(--text-muted); font-size: 0.9rem">
            Browse events, select your preferred ticket type, and proceed to
            checkout. You will receive a QR code ticket.
          </p>
        </div>
        <div style="margin-bottom: 16px">
          <h4 style="margin-bottom: 8px">How to become an organizer?</h4>
          <p style="color: var(--text-muted); font-size: 0.9rem">
            Sign up and select "Organizer" as your role during registration. You
            can then create and manage events from your dashboard.
          </p>
        </div>
      </div>
    </div>

    <!-- ORGANIZER CHAT WIDGET -->
    <div class="chat-widget">
      <div class="chat-window" id="organizerChatWindow">
        <div class="chat-header">
          <i
            class="ph ph-headset"
            style="font-size: 1.5rem; color: var(--primary)"
          ></i>
          <h3 style="font-size: 0.95rem">Support Chat</h3>
          <button
            onclick="app.chat.toggle()"
            style="background: none; color: var(--text-muted); padding: 0"
          >
            <i class="ph ph-x"></i>
          </button>
        </div>
        <div class="chat-body" id="orgChatBody">
          <div
            style="
              text-align: center;
              margin-top: 40px;
              color: var(--text-muted);
            "
          >
            <i
              class="ph ph-chats-circle"
              style="font-size: 3rem; opacity: 0.3"
            ></i>
            <p style="font-size: 0.8rem; margin-top: 10px">How can we help?</p>
          </div>
        </div>
        <div class="chat-footer" id="orgChatFooter" style="display: none">
          <textarea
            class="chat-input"
            id="orgChatInput"
            placeholder="Type message..."
            rows="1"
            onkeydown="
              if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                app.chat.send();
              }
            "
          ></textarea>
          <button
            class="btn btn-primary"
            style="padding: 8px 10px; height: 38px"
            onclick="app.chat.send()"
          >
            <i class="ph ph-paper-plane-tilt"></i>
          </button>
        </div>
      </div>
      <button class="chat-toggle-btn" onclick="app.chat.toggle()">
        <i class="ph ph-chat-dots"></i>
        <span class="unread-badge" id="orgChatBadge">0</span>
      </button>
    </div>

    <script>
      // ==========================================
      // CONFIGURATION
      // ==========================================
      const API_URL =
        "https://script.google.com/macros/s/AKfycbxKNu9aoU1uMfdci1jAnMf2wA1nvyyXUNIg8frXxkPb_mPHWqKhbnQVJCyM57n9vlyItA/exec";
      const fmtMoney = (amount) => {
        const num = parseFloat(amount) || 0;
        return "₦" + num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };
      const compressImage = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              let width = img.width;
              let height = img.height;
              const MAX_WIDTH = 400;
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
              const canvas = document.createElement("canvas");
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);
              resolve(canvas.toDataURL("image/jpeg", 0.5));
            };
            img.onerror = (err) => reject(err);
          };
          reader.onerror = (err) => reject(err);
        });
      };

      const compressBgImage = (file) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
              const canvas = document.createElement("canvas");
              let w = img.width;
              let h = img.height;
              if (w > 1920) {
                h = (h * 1920) / w;
                w = 1920;
              }
              canvas.width = w;
              canvas.height = h;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, w, h);
              resolve(canvas.toDataURL("image/jpeg", 0.6));
            };
            img.onerror = reject;
          };
          reader.onerror = reject;
        });
      };

      const api = {
        post: async (action, data = {}) => {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            const response = await fetch(API_URL, {
              method: "POST",
              body: JSON.stringify({ ...data, action }),
              signal: controller.signal,
            });
            clearTimeout(timeoutId);
            const json = await response.json();
            if (json.status === "error") throw new Error(json.message);
            return json;
          } catch (e) {
            console.error("API Error:", e);
            if (e.name !== "AbortError") {
              app.ui.showToast(e.message || "Network Error", "error");
            }
            return null;
          }
        },
        getEventsCached: async () => {
          const cached = localStorage.getItem("eh_events_cache");
          let cachedData = null;
          if (cached) {
            try {
              cachedData = JSON.parse(cached);
            } catch (e) {}
          }
          const freshRes = await api.post("getEvents");
          if (freshRes && freshRes.data) {
            localStorage.setItem(
              "eh_events_cache",
              JSON.stringify(freshRes.data),
            );
            return freshRes.data;
          }
          if (cachedData) return cachedData;
          return [];
        },
      };

      // ==========================================
      // APPLICATION LOGIC
      // ==========================================
      const app = {
        state: {
          isLoginMode: true,
          cart: {},
          feePercentage: 0.05,
          currentEventId: null,
          currentEventData: null,
          currentUser: JSON.parse(localStorage.getItem("eh_session")) || null,
          userProfile:
            JSON.parse(localStorage.getItem("eh_user_profile")) || {},
          customBg: localStorage.getItem("eh_custom_bg") || null,
          currentTicketData: null,
          favorites: JSON.parse(localStorage.getItem("eh_favorites")) || [],
          allEvents: [],
          paystackKey: "pk_test_7a54febd2f475fd5e0397685912b81770c212888",
          lastViewedEventId: null, // For back navigation
          appliedCoupon: null, // Stores the valid coupon object
        },
        init: async () => {
          // 1. Load session from storage
          app.ui.checkSession();
          app.ui.loadProfilePic();
          app.ui.applyCustomTheme();

          // 2. Validate User Status with Server (The Fix)
          const user = app.state.currentUser;
          if (user && user.id) {
            const statusRes = await api.post("checkUserStatus", {
              userId: user.id,
            });
            if (statusRes && statusRes.status === "success") {
              if (statusRes.banned) {
                // User is banned! Update state immediately
                app.state.currentUser.banned = true;
                localStorage.setItem(
                  "eh_session",
                  JSON.stringify(app.state.currentUser),
                );
              }
            } else {
              // If check fails (user deleted?), force logout
              // localStorage.removeItem("eh_session");
              // app.state.currentUser = null;
              // app.ui.checkSession();
            }
          }

          const preloader = document.getElementById("preloader");
          setTimeout(() => {
            preloader.style.opacity = "0";
            setTimeout(() => preloader.remove(), 500);
          }, 600);
          const params = new URLSearchParams(window.location.search);
          const eventId = params.get("eventId");
          if (eventId) {
            app.router.navigate("event", eventId);
          } else {
            app.router.navigate("home");
          }
          // Start checking for unread messages if user is logged in
          if (app.state.currentUser) {
            app.chat.startBadgePolling();
          }
        },
        router: {
          navigate: async (viewName, params = null) => {
            const main = document.getElementById("app");
            app.router.current = viewName;
            window.scrollTo(0, 0);
            app.ui.updateMobileNav(viewName);
            if (viewName === "home")
              app.views.renderHome(main, params); // Pass params for scroll
            else if (viewName === "favorites") app.views.renderFavorites(main);
            else if (viewName === "dashboard") app.views.renderMyTickets(main);
            else if (viewName === "event")
              app.views.renderEventDetail(main, params);
            else if (viewName === "organizer")
              app.views.renderOrganizerDashboard(main);
          },
        },
        views: {
          renderHome: async (container, scrollToId = null) => {
            const cached = localStorage.getItem("eh_events_cache");
            if (cached) {
              const events = JSON.parse(cached);
              app.state.allEvents = events;
              container.innerHTML = app.views.generateEventGrid(events);
              // Scroll logic
              if (scrollToId) {
                setTimeout(() => {
                  const el = document.getElementById(
                    `event-card-${scrollToId}`,
                  );
                  if (el)
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                }, 100);
              }

              api.getEventsCached().then((freshEvents) => {
                app.state.allEvents = freshEvents;
                if (app.router.current === "home")
                  container.innerHTML =
                    app.views.generateEventGrid(freshEvents);
              });
            } else {
              container.innerHTML = `<div class="page-loader"><div class="loader-ring" style="width:40px; height:40px; margin:0;"></div></div>`;
              const events = await api.getEventsCached();
              app.state.allEvents = events;
              if (app.router.current === "home")
                container.innerHTML = app.views.generateEventGrid(events);
            }
          },
          renderFavorites: async (container) => {
            const events = await api.getEventsCached();
            const favEvents = events.filter((e) =>
              app.state.favorites.includes(e.id),
            );
            container.innerHTML = `<div class="view active"><h1 style="margin-bottom: 20px;">Favorites</h1>${app.views.generateEventGrid(favEvents, true)}</div>`;
          },
          generateEventGrid: (events, isFavView = false) => {
            // Define "today" for filtering/sorting
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of day

            if (events.length === 0)
              return `<div class="card" style="text-align:center; color:var(--text-muted); padding:40px;">No events found.</div>`;

            let popularHTML = "";
            if (!isFavView) {
              // Popular Events: Sort by popularity, keep past events (as requested)
              const sortedByPop = [...events]
                .sort((a, b) => {
                  const aSold = a.tickets.reduce(
                    (s, t) => s + (t.sold || 0),
                    0,
                  );
                  const bSold = b.tickets.reduce(
                    (s, t) => s + (t.sold || 0),
                    0,
                  );
                  return bSold - aSold;
                })
                .slice(0, 5);

              if (sortedByPop.length > 0) {
                popularHTML = `
                    <div class="popular-section">
                        <div class="section-title"><i class="ph ph-fire-fill"></i> Popular Events</div>
                        <div class="popular-scroll">
                            ${sortedByPop
                              .map(
                                (e) => `
                                <div class="popular-card" onclick="app.router.navigate('event', '${e.id}')">
                                    <span class="popular-badge"><i class="ph ph-lightning-fill"></i> Trending</span>
                                    <img src="${e.image || `https://picsum.photos/seed/${e.title}/400/225`}" />
                                    <div class="popular-info">
                                        <h3 style="font-size: 1rem; margin-bottom: 4px;">${e.title}</h3>
                                        <div style="color:var(--text-muted); font-size: 0.8rem;">${new Date(e.date).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>`;
              }
            }

            // Filter & Sort Main Grid
            // 1. Filter: Remove past events (only show today or future)
            // 2. Sort: Ascending date (nearest date first)
            let displayEvents = events;
            if (!isFavView) {
              displayEvents = events
                .filter((e) => {
                  const eventDate = new Date(e.date);
                  eventDate.setHours(0, 0, 0, 0);
                  return eventDate >= today;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            } else {
              // For favorites view, just sort, don't filter
              displayEvents = events.sort(
                (a, b) => new Date(a.date) - new Date(b.date),
              );
            }

            return `
              <div class="view active">
                ${
                  !isFavView
                    ? `
                <section class="hero" style="text-align: center;">
                  <h1 style="font-size: 2.5rem;">Discover Events</h1>
                  <p style="font-size:1rem; color:var(--text-muted); margin-top:8px;">Find the best events happening near you.</p>
                  <div class="search-bar-container" style="max-width: 500px; margin: 24px auto 0;">
                      <i class="ph ph-magnifying-glass search-icon"></i>
                      <input type="text" id="searchInput" class="search-bar" placeholder="Search events..." onkeyup="app.handlers.filterEvents()" />
                  </div>
                </section>`
                    : ""
                }
               
                ${popularHTML}
               
                ${
                  !isFavView
                    ? `
                <div class="category-pills" id="categoryPills">
                    <div class="pill active" onclick="app.handlers.filterCategory('All')"><i class="ph ph-squares-four"></i></div>
                    <div class="pill" onclick="app.handlers.filterCategory('Music')"><i class="ph ph-music-notes"></i></div>
                    <div class="pill" onclick="app.handlers.filterCategory('Tech')"><i class="ph ph-cpu"></i></div>
                    <div class="pill" onclick="app.handlers.filterCategory('Business')"><i class="ph ph-briefcase"></i></div>
                </div>`
                    : ""
                }
               
                <h3 style="margin-bottom: 16px; font-size: 1.1rem;">${isFavView ? "Your Favorites" : "All Events"}</h3>
                <div class="events-grid" id="eventsGrid">
                  ${displayEvents
                    .map((e) => {
                      if (!e.image)
                        e.image = `https://picsum.photos/seed/${e.title || "default"}/400/225`;
                      const internalTickets = e.tickets.filter(
                        (t) => !t.isExternal,
                      );
                      let isSoldOut = false;
                      if (internalTickets.length > 0) {
                        const totalQty = internalTickets.reduce(
                          (acc, t) => acc + (t.qty || 0),
                          0,
                        );
                        const totalSold = internalTickets.reduce(
                          (acc, t) => acc + (t.sold || 0),
                          0,
                        );
                        if (totalQty > 0 && totalSold >= totalQty)
                          isSoldOut = true;
                      }
                      const externalTicket = e.tickets.find(
                        (t) => t.isExternal,
                      );
                      const priceDisplay =
                        internalTickets.length > 0
                          ? internalTickets.some((t) => t.accessType === "free")
                            ? "Free"
                            : fmtMoney(
                                Math.min(
                                  ...internalTickets.map((t) => t.price),
                                ),
                              )
                          : "External";
                      const isFav = app.state.favorites.includes(e.id);
                      // Inside the map function...
                      return `
  <div class="event-card ${internalTickets.length === 0 && externalTicket ? "external-only" : ""}"
       id="event-card-${e.id}"
       data-category="${e.category}"
       data-title="${e.title.toLowerCase()}"
       onclick="${e.organizerBanned ? "" : `app.router.navigate('event', '${e.id}')`}" 
       style="${e.organizerBanned ? "opacity: 0.7; pointer-events: none;" : ""}">
    <div class="event-img">
      <img src="${e.image}" alt="${e.title}" loading="lazy" />
      <button class="fav-btn ${isFav ? "active" : ""}" onclick="event.stopPropagation(); app.handlers.toggleFavorite('${e.id}')">
        <i class="ph ${isFav ? "ph-heart-fill" : "ph-heart"}"></i>
      </button>
    </div>
    <div class="event-card-content">
      <div class="event-card-header">
        <span class="badge badge-cat">${e.category}</span>
        <span style="color:var(--text-muted); font-size:0.85rem;">
          ${new Date(e.date).toLocaleDateString("en-GB", { day: "numeric", month: "short" })}
        </span>
      </div>
      <h3 class="event-card-title">${e.title}</h3>
      <div class="event-card-meta">
        <span><i class="ph ph-map-pin"></i> ${e.location}</span>
      </div>
      <div class="event-card-footer">
        <span class="event-price">${priceDisplay}</span>
        ${
          e.organizerBanned
            ? `<button class="btn btn-secondary btn-sm" disabled>Unavailable</button>`
            : isSoldOut
              ? `<button class="btn btn-secondary btn-sm" disabled>Sold Out</button>`
              : externalTicket && internalTickets.length === 0
                ? `<a href="${externalTicket.externalLink}" ... >Get External Ticket →</a>`
                : `<button class="btn btn-primary btn-sm">Get Ticket</button>`
        }
      </div>
    </div>
  </div>`;
                    })
                    .join("")}
                </div>
              </div>`;
          },
          renderEventDetail: async (container, eventId) => {
            container.innerHTML = `<div class="page-loader"><div class="loader-ring" style="width:30px; height:30px; margin:0 auto;"></div></div>`;
            const events = await api.getEventsCached();
            const event = events.find((e) => e.id === eventId);
            if (!event) return app.router.navigate("home");

            // Date Check
            const eventDate = new Date(event.date);
            eventDate.setHours(23, 59, 59, 0); // End of the event day
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastEvent = eventDate < today;

            app.state.lastViewedEventId = eventId;
            app.state.currentEventId = eventId;
            app.state.currentEventData = event;
            app.state.cart = {};
            app.state.appliedCoupon = null; // Reset coupon on load

            // Identify internal vs external tickets
            const internalTickets = event.tickets.filter(
              (t) => !t.isExternal && !t.externalLink,
            );
            const hasInternalTickets = internalTickets.length > 0;

            // Initialize cart for internal tickets only
            internalTickets.forEach((t) => {
              app.state.cart[t.ticketId] = 0;
            });

            const isFav = app.state.favorites.includes(event.id);
            const currentUserId = app.state.currentUser
              ? String(
                  app.state.currentUser.id || app.state.currentUser.user_id,
                )
              : null;
            const isMyEvent = String(event.organizerId) === currentUserId;
            const profile = app.state.userProfile;
            let orgAvatarHTML = "";
            if (isMyEvent && profile && profile.pic) {
              orgAvatarHTML = `<img src="${profile.pic}" alt="Organizer" />`;
            } else {
              orgAvatarHTML = event.organizerName
                ? event.organizerName.charAt(0)
                : "U";
            }

            // Check for unlocked invite tickets
            let unlockedInviteTypes = new Set();
            if (currentUserId) {
              const purchasesRes = await api.post("getPurchases", {
                buyerId: currentUserId,
              });
              if (purchasesRes?.status === "success") {
                purchasesRes.data.forEach((p) => {
                  if (
                    String(p.event_id) === eventId &&
                    p.payment_ref === "INVITE_UNLOCK"
                  ) {
                    unlockedInviteTypes.add(p.ticket_type);
                  }
                });
              }
            }

            let ticketListHTML = "";
            let sectionHeader = "Get Tickets";

            // ACTIVE EVENT LOGIC
            // Check if Organizer is Banned
            if (event.organizerBanned) {
              sectionHeader = "Event Unavailable";
              ticketListHTML = `
                 <div class="ticket-item" style="border-left: 4px solid var(--danger); padding: 24px; text-align: center;">
                    <h3 style="color: var(--danger); margin-bottom: 8px;">Event Unavailable</h3>
                    <p style="color: var(--text-muted);">This organizer is currently undergoing an investigation. Ticket sales have been temporarily suspended.</p>
                 </div>`;
            }
            // Check if Event is Passed
            else if (isPastEvent) {
              sectionHeader = "Event Ended";
              ticketListHTML = `
                 <div class="ticket-item" style="border-left: 4px solid var(--danger); padding: 24px; text-align: center;">
                    <h3 style="color: var(--danger); margin-bottom: 8px;">This event has passed</h3>
                    <p style="color: var(--text-muted);">Tickets are no longer available for this event.</p>
                 </div>`;
            } else {
              // ACTIVE EVENT LOGIC
              ticketListHTML = event.tickets
                .map((ticket) => {
                  // --- EXTERNAL TICKET DESIGN ---
                  if (ticket.isExternal || ticket.externalLink) {
                    return `
                    <div class="ticket-item external-ticket-item" onclick="window.open('${ticket.externalLink}', '_blank')" style="cursor: pointer; background: rgba(99, 102, 241, 0.08); border-left: 4px solid var(--primary); display: flex; flex-direction: column; gap: 12px;">
                      <div class="ticket-info">
                        <div class="ticket-name" style="font-weight: 600; font-size: 1.1rem;">${ticket.type}</div>
                        <div style="color:var(--primary); margin:4px 0; font-weight: 500;">External Registration</div>
                        <small style="color:var(--text-muted); display: block; margin-top: 4px;">Click to visit organizer's website</small>
                      </div>
                      <a href="${ticket.externalLink}" target="_blank" class="btn btn-primary" style="width: 100%; text-align: center; text-decoration: none;" onclick="event.stopPropagation()">
                        Get Ticket <i class="ph ph-arrow-square-out" style="margin-left: 8px;"></i>
                      </a>
                    </div>`;
                  }

                  // --- INTERNAL TICKET LOGIC ---
                  const remaining = ticket.qty - ticket.sold;
                  // FIX: Only show sold out if qty > 0 and remaining is 0. If qty is 0, assume unlimited/available.
                  const isSoldOut = ticket.qty > 0 && remaining <= 0;

                  if (ticket.accessType === "invite") {
                    const isUnlocked = unlockedInviteTypes.has(ticket.type);
                    if (!isUnlocked) {
                      return `
                      <div class="ticket-item">
                        <div class="ticket-info">
                          <div class="ticket-name" style="font-weight: 600;">
                            ${ticket.type} <i class="ph ph-lock" style="color:var(--accent)"></i>
                          </div>
                          <div class="ticket-meta" style="color:var(--text-muted);">
                            Invite / Password Required
                          </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                          <input
                            type="password"
                            id="pw-input-${ticket.ticketId}"
                            placeholder="Enter password"
                            style="padding:10px; border-radius:6px; width:160px; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white;"
                          />
                          <button
                            class="btn btn-secondary btn-sm"
                            onclick="app.handlers.unlockInvite('${ticket.ticketId}', '${String(ticket.access_password || ticket.accessPassword || "").replace(/'/g, "\\'")}')"
                          >
                            Unlock
                          </button>
                        </div>
                      </div>`;
                    }
                  }

                  const priceDisplay =
                    ticket.accessType === "free"
                      ? '<span style="color:var(--success); font-weight:700;">Free</span>'
                      : fmtMoney(ticket.price);

                  return `
                  <div class="ticket-item" id="ticket-row-${ticket.ticketId}">
                    <div class="ticket-info">
                      <div class="ticket-name" style="font-weight: 600;">
                        ${ticket.type} ${isSoldOut ? "<span style='color:var(--danger) font-size:0.8rem;'>(Sold Out)</span>" : ""}
                      </div>
                      <div class="ticket-meta" style="color: var(--primary); font-weight: 700;">
                        ${priceDisplay}
                        ${!isSoldOut && ticket.qty > 0 ? `<span style="color:var(--text-muted); font-weight:400; font-size: 0.85rem; margin-left: 8px;">• ${remaining} left</span>` : ""}
                      </div>
                    </div>
                    ${
                      !isSoldOut
                        ? `
                      <div class="qty-control">
                        <button class="qty-btn" onclick="app.handlers.updateTicketQty('${ticket.ticketId}', -1)">-</button>
                        <span class="qty-value" id="qty-${ticket.ticketId}">0</span>
                        <button class="qty-btn" onclick="app.handlers.updateTicketQty('${ticket.ticketId}', 1)">+</button>
                      </div>`
                        : '<button class="btn btn-secondary btn-sm" disabled>Sold Out</button>'
                    }
                  </div>`;
                })
                .join("");

              sectionHeader = hasInternalTickets
                ? "Select Tickets"
                : "Get Tickets";
            }

            // Only show breakdown and button if there are internal tickets AND event is NOT past
            const priceBreakdownHTML =
              hasInternalTickets && !isPastEvent
                ? `
              <div class="price-breakdown">
                <div id="breakdownItems"></div>
                <div class="price-row"><span>Service Fee (5%)</span><span id="feeDisplay">${fmtMoney(0)}</span></div>
                
                <!-- COUPON SECTION -->
                <div id="couponInputArea" style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="couponCodeInput" placeholder="Promo Code" style="padding: 8px; border-radius: 6px; flex: 1; margin-bottom: 0;" />
                    <button class="btn btn-secondary btn-sm" onclick="app.handlers.applyCoupon()">Apply</button>
                  </div>
                  <div id="couponStatus" style="font-size: 0.8rem; margin-top: 5px;"></div>
                </div>
                <!-- END COUPON SECTION -->

                <div class="price-row total"><span>Total</span><span id="totalDisplay">${fmtMoney(0)}</span></div>
              </div>
            `
                : "";

            const buyButtonHTML =
              hasInternalTickets && !isPastEvent
                ? `
              <button id="buyBtn" class="btn btn-primary" style="width:100%; justify-content:center; margin-top:20px; padding:18px; font-size: 1.1rem; border-radius: 16px;" disabled onclick="app.handlers.initBuy()">Select Tickets</button>
            `
                : "";

            container.innerHTML = `
    <div class="view active">
      <div class="detail-top-actions">
        <button class="btn btn-secondary" onclick="app.router.navigate('home', '${event.id}')" style="border:none; background:transparent; padding:0; color: var(--text-muted); display:flex; align-items:center; gap:5px;">
          <i class="ph ph-arrow-left" style="font-size: 1.5rem;"></i> <span>Back</span>
        </button>
        <button class="fav-btn ${isFav ? "active" : ""}" style="position:relative; top:0; right:0;" onclick="app.handlers.toggleFavorite('${event.id}')">
          <i class="ph ${isFav ? "ph-heart-fill" : "ph-heart"}"></i>
        </button>
      </div>
      <div class="detail-header">
        <div class="detail-img" style="background-image:url('${event.image || `https://picsum.photos/seed/${event.title || "default"}/800/600`}');"></div>
        <div class="detail-content">
          <span class="badge badge-cat">${event.category}</span>
          <h1 style="font-size: 2.2rem; line-height: 1.2; margin: 10px 0;">${event.title}</h1>
          <div style="color:var(--text-muted); margin-bottom:24px; font-size: 1rem;">
            <div style="margin-bottom: 8px;"><i class="ph ph-calendar-blank"></i> ${new Date(event.date).toDateString()}</div>
            <div><i class="ph ph-map-pin"></i> ${event.location}</div>
          </div>
          ${event.description ? `<div class="description-box"><h4>About Event</h4><p>${event.description}</p></div>` : ""}
          <div class="organizer-card">
            <div class="org-avatar">${orgAvatarHTML}</div>
            <div class="org-info" style="flex:1">
              <h4>${event.organizerName || "Unknown Organizer"}</h4>
              <span>Organizer</span>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="app.ui.showToast('Followed!')"><i class="ph ph-user-plus"></i> Follow</button>
          </div>
          <div class="ticket-list-container">
            <h3 style="padding: 16px 16px 0; color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">${sectionHeader}</h3>
            ${ticketListHTML}
          </div>
          ${priceBreakdownHTML}
          ${buyButtonHTML}
        </div>
      </div>
    </div>`;

            if (hasInternalTickets && !isPastEvent) {
              app.handlers.updateSummary();
            }
          },
          renderMyTickets: async (container) => {
            if (!app.state.currentUser) {
              app.ui.openAuthModal("login");
              return;
            }
            const user = app.state.currentUser;
            const buyerId = user.id || user.user_id || null;
            if (!buyerId) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="text-align:center; padding:40px; color:#f87171;"><p>Error: No user ID found.</p></div></div>`;
              return;
            }
            container.innerHTML = `<div class="page-loader"><div class="loader-ring"></div></div>`;
            const purchaseRes = await api.post("getPurchases", { buyerId });
            if (
              !purchaseRes ||
              purchaseRes.status !== "success" ||
              !Array.isArray(purchaseRes.data)
            ) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="padding:20px; color:#f87171;"><p>Could not load your tickets.</p></div></div>`;
              return;
            }
            if (purchaseRes.data.length === 0) {
              container.innerHTML = `<div class="view active"><h1>My Tickets</h1><div class="card" style="text-align:center; padding:40px; color:var(--text-muted);"><i class="ph ph-ticket" style="font-size:3rem; margin-bottom:10px;"></i><p>You haven't purchased any tickets yet.</p><button class="btn btn-primary" style="margin-top:20px;" onclick="app.router.navigate('home')">Browse Events</button></div></div>`;
              return;
            }
            const eventsRes = await api.getEventsCached();
            const eventsMap = new Map(eventsRes.map((e) => [e.id, e]));
            const ticketsHTML = purchaseRes.data
              .map((p) => {
                const evt = eventsMap.get(p.event_id);
                const qrData = JSON.stringify({
                  pid: p.purchase_id,
                  evt: p.event_id,
                  qty: p.quantity,
                  type: p.ticket_type,
                });
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}`;
                const ticketDataStr = encodeURIComponent(
                  JSON.stringify({
                    title: evt ? evt.title : "Unknown Event",
                    date: evt ? new Date(evt.date).toLocaleDateString() : "TBD",
                    type: p.ticket_type,
                    qty: p.quantity,
                    total: fmtMoney(p.total_paid),
                    qrData: qrData,
                    id: p.purchase_id,
                  }),
                );
                return `<div class="ticket-visual" onclick="app.handlers.openTicketDetail('${ticketDataStr}')"><div class="tv-cutout left"></div><div class="tv-cutout right"></div><div class="tv-main"><div><div class="tv-label">Event</div><h3 class="tv-title">${evt ? evt.title : "Unknown Event"}</h3><div class="tv-row"><i class="ph ph-calendar-blank"></i><span>${evt ? new Date(evt.date).toLocaleDateString() : "TBD"}</span></div><div class="tv-row"><i class="ph ph-map-pin"></i><span>${evt ? evt.location : "N/A"}</span></div></div><div style="margin-top:20px;"><div class="tv-label">Ticket Type</div><div class="tv-value">${p.ticket_type} × ${p.quantity}</div></div></div><div class="tv-stub"><img src="${qrUrl}" alt="QR Code" class="tv-qr" /><div class="tv-label" style="margin-top: 8px;">Scan to Enter</div><div class="tv-value" style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;">Order #${p.purchase_id.slice(-6)}</div></div></div>`;
              })
              .join("");
            container.innerHTML = `<div class="view active"><h1 style="margin-bottom: 20px;">My Tickets</h1><div style="margin-bottom: 10px; color: var(--text-muted); font-size: 0.9rem; text-align: center;">Tap a ticket to view/share</div><div class="tickets-grid">${ticketsHTML}</div></div>`;
          },
          renderOrganizerDashboard: async (container) => {
            const user = app.state.currentUser;
            if (!user) {
              app.router.navigate("home");
              return;
            }
            // --- NEW: BAN CHECK ---
            if (
              user.banned === true ||
              user.banned === "true" ||
              user.banned === "TRUE"
            ) {
              container.innerHTML = `
                <div class="view active">
                  <div class="card" style="text-align:center; padding: 50px 20px; margin-top: 50px; border: 1px solid var(--danger); max-width: 500px; margin-left: auto; margin-right: auto;">
                    <i class="ph ph-prohibit" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
                    <h2 style="color: var(--danger); margin-bottom: 10px;">Account Suspended</h2>
                    <p style="color: var(--text-muted); margin-bottom: 30px; line-height: 1.6;">
                      Your account has been suspended due to a violation of our policies. 
                      If you believe this is a mistake, please contact our support team.
                    </p>
                    <button class="btn btn-primary" onclick="app.ui.openModal('contactModal')">
                      <i class="ph ph-envelope"></i> Contact Support
                    </button>
                  </div>
                </div>
              `;
              return;
            }
            container.innerHTML = `<div class="view active"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h1>Organizer Dashboard</h1><button class="btn btn-primary" onclick="app.handlers.openEventModal()"><i class="ph ph-plus"></i> Create Event</button></div><div class="page-loader"><div class="loader-ring"></div></div></div>`;
            const [eventsRes, wRes, pRes] = await Promise.all([
              api.post("getEvents"),
              api.post("getWithdrawals", {
                organizerId:
                  app.state.currentUser.id || app.state.currentUser.user_id,
              }),
              api.post("getPurchases"),
            ]);
            const allEvents = eventsRes?.data ?? [];
            const withdrawals = wRes?.data ?? [];
            const allPurchases = pRes?.data ?? [];
            const currentOrganizerId = String(user.id || user.user_id || "");
            const myEvents = allEvents.filter(
              (e) => String(e.organizerId || "") === currentOrganizerId,
            );
            const myEventIds = myEvents.map((e) => e.id);
            const mySales = allPurchases.filter((p) =>
              myEventIds.includes(p.event_id),
            );
            // ... inside renderOrganizerDashboard ...

            // FIX: Calculate based on actual amount paid by buyer (after discount)
            const grossRevenue = mySales.reduce((sum, p) => {
              const totalPaid = Number(p.total_paid || 0);
              const serviceFee = Number(p.service_fee || 0);

              // Organizer Share = Total Paid - Platform Fee
              // (We no longer use 'subtotal' here because that is the full price before discount)
              const organizerShare = totalPaid - serviceFee;

              return sum + (organizerShare > 0 ? organizerShare : 0);
            }, 0);

            // ... existing code ...
            const totalPaidOut = withdrawals
              .filter((w) => w.status === "Approved" || w.status === "Pending")
              .reduce((sum, w) => sum + Number(w.amount || 0), 0);
            const balance = grossRevenue - totalPaidOut;
            const totalTicketsSold = myEvents.reduce(
              (acc, e) =>
                acc + e.tickets.reduce((a, t) => a + (t.sold || 0), 0),
              0,
            );
            container.innerHTML = `<div class="view active"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h1>Organizer Dashboard</h1><button class="btn btn-primary" onclick="app.handlers.openEventModal()"><i class="ph ph-plus"></i> Create Event</button></div><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom:30px;"><div class="card"><h3>Available Balance</h3><h2 style="color:var(--primary); margin:10px 0;">${fmtMoney(balance)}</h2></div><div class="card"><h3>Total Tickets Sold</h3><h2 style="margin:10px 0;">${totalTicketsSold}</h2></div><div class="card" style="border-color:var(--accent); background:rgba(236,72,153,0.05)"><h3>Total Paid Out</h3><h2 style="color:var(--accent); margin:10px 0;">${fmtMoney(totalPaidOut)}</h2></div></div><div class="card"><h2>My Events</h2>${
              myEvents.length === 0
                ? '<p style="color:var(--text-muted); text-align:center; padding:40px 0;">You haven\'t created any events yet.</p>'
                : `<div class="table-wrapper"><table><thead><tr><th>Event</th><th>Date</th><th>Sales</th><th>Action</th></tr></thead><tbody>${myEvents
                    .map((e) => {
                      const totalQty = e.tickets.reduce(
                        (s, t) => s + (t.qty || 0),
                        0,
                      );
                      const sold = e.tickets.reduce(
                        (s, t) => s + (t.sold || 0),
                        0,
                      );
                      const isSoldOut = totalQty > 0 && sold >= totalQty;
                      return `<tr><td><strong>${e.title}</strong>${isSoldOut ? '<span class="badge badge-sold" style="margin-left:8px;">Sold Out</span>' : '<span class="badge badge-open" style="margin-left:8px;">Active</span>'}</td><td>${new Date(e.date).toLocaleDateString("en-GB")}</td><td>${sold} / ${totalQty}</td><td style="white-space:nowrap;"><button class="btn btn-secondary btn-sm" onclick="app.handlers.shareEventLink('${e.id}')" style="margin-right:8px;" title="Copy Link"><i class="ph ph-share-network"></i></button><button class="btn btn-secondary btn-sm" onclick="app.handlers.editEvent('${e.id}')" style="margin-right:8px;">Edit</button><button class="btn btn-danger btn-sm" onclick="app.handlers.deleteEvent('${e.id}')">Delete</button></td></tr>`;
                    })
                    .join("")}</tbody></table></div>`
            }</div><div class="card"><h2>Payout History</h2>${withdrawals.length === 0 ? '<p style="color:var(--text-muted)">No withdrawal requests yet.</p>' : `<div class="table-wrapper"><table><thead><tr><th>Amount</th><th>Bank</th><th>Account</th><th>Status</th><th>Date</th></tr></thead><tbody>${withdrawals.map((w) => `<tr><td>${fmtMoney(w.amount)}</td><td>${w.bankName || "-"}</td><td>${w.accountNum || "-"}</td><td><span class="badge" style="background:${w.status === "Approved" ? "var(--success)" : w.status === "Pending" ? "#f59e0b" : "var(--text-muted)"}">${w.status}</span></td><td>${new Date(w.date).toLocaleDateString("en-GB")}</td></tr>`).join("")}</tbody></table></div>`}<div style="margin-top:20px; text-align:right;"><button class="btn btn-primary" onclick="app.handlers.openWithdrawalModal(${balance})" ${balance <= 0 ? "disabled" : ""}>Request Withdrawal</button></div></div></div>`;
          },
        },

        handlers: {
          filterEvents: () => {
            const searchTerm = document
              .getElementById("searchInput")
              .value.toLowerCase();
            const cards = document.querySelectorAll(".event-card");
            cards.forEach((card) => {
              const title = card.getAttribute("data-title");
              if (title.includes(searchTerm)) card.style.display = "flex";
              else card.style.display = "none";
            });
          },
          filterCategory: (cat) => {
            document
              .querySelectorAll(".pill")
              .forEach((p) => p.classList.remove("active"));
            event.target.closest(".pill").classList.add("active");
            const cards = document.querySelectorAll(".event-card");
            cards.forEach((card) => {
              const cardCat = card.getAttribute("data-category");
              if (cat === "All" || cardCat === cat) card.style.display = "flex";
              else card.style.display = "none";
            });
          },
          toggleFavorite: (id) => {
            const index = app.state.favorites.indexOf(id);
            if (index > -1) {
              app.state.favorites.splice(index, 1);
              app.ui.showToast("Removed from favorites");
            } else {
              app.state.favorites.push(id);
              app.ui.showToast("Added to favorites");
            }
            localStorage.setItem(
              "eh_favorites",
              JSON.stringify(app.state.favorites),
            );
            if (app.router.current === "home") app.router.navigate("home");
            else if (app.router.current === "favorites")
              app.router.navigate("favorites");
            else if (app.router.current === "event")
              app.router.navigate("event", id);
          },
          updateTicketQty: (ticketId, change) => {
            const ticket = app.state.currentEventData.tickets.find(
              (t) => String(t.ticketId) == String(ticketId),
            );
            if (!ticket) return;
            const current = app.state.cart[ticketId] || 0;
            const newQty = current + change;
            if (newQty < 0) return;
            const remaining = ticket.qty - ticket.sold;
            if (newQty > remaining) {
              app.ui.showToast(
                `Sorry, only ${remaining} tickets remaining for ${ticket.type}.`,
                "error",
              );
              return;
            }
            app.state.cart[ticketId] = newQty;
            const qtyEl = document.getElementById(`qty-${ticketId}`);
            if (qtyEl) qtyEl.innerText = newQty;
            app.handlers.updateSummary();
          },
          updateSummary: () => {
            if (!app.state.currentEventData) return;

            const breakdownContainer =
              document.querySelector(".price-breakdown");
            if (!breakdownContainer) return;

            let subtotal = 0;
            let breakdownHTML = "";
            let itemCount = 0;

            // Calculate totals and generate item list
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => String(t.ticketId) == String(tid),
                );
                if (ticket) {
                  subtotal += ticket.price * qty;
                  itemCount += qty;
                  // Show line items
                  if (ticket.price > 0) {
                    breakdownHTML += `<div class="price-row"><span>${ticket.type} (x${qty})</span><span>${fmtMoney(ticket.price * qty)}</span></div>`;
                  } else {
                    breakdownHTML += `<div class="price-row"><span>${ticket.type} (x${qty})</span><span style="color:var(--success)">Free</span></div>`;
                  }
                }
              }
            });

            const btn = document.getElementById("buyBtn");

            // Handle Empty Cart
            if (itemCount === 0) {
              // Reset UI if cart is empty
              const couponStatus = document.getElementById("couponStatus");
              if (couponStatus) couponStatus.innerHTML = "";

              // We wipe the container content for empty state
              breakdownContainer.innerHTML = "";

              if (btn) {
                btn.disabled = true;
                btn.innerText = "Select Tickets";
              }
              return;
            }

            // Calculate Fee
            let fee = subtotal * app.state.feePercentage;
            let discount = 0;
            let discountHTML = "";

            // Apply Coupon if valid
            if (app.state.appliedCoupon) {
              const cp = app.state.appliedCoupon;
              if (cp.type === "percent") {
                discount = subtotal * (cp.value / 100);
              } else {
                discount = cp.value;
              }
              // Ensure discount doesn't exceed subtotal
              if (discount > subtotal) discount = subtotal;

              discountHTML = `<div class="price-row discount-row" style="color: var(--success);"><span>Discount (${cp.code})</span><span>-${fmtMoney(discount)}</span></div>`;
            }

            let total = subtotal - discount + fee;
            // Ensure total isn't negative
            if (total < 0) total = 0;

            // Logic: Free vs Paid Breakdown
            if (subtotal === 0 && discount === 0) {
              // --- FREE TICKETS DESIGN ---
              breakdownContainer.innerHTML = `
                  <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--success); margin-bottom: 4px;">
                       <i class="ph ph-check-circle" style="position: relative; top: 2px;"></i> Free Tickets Selected
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9rem;">
                       No payment is required for this ticket.
                    </div>
                  </div>
                `;

              if (btn) {
                btn.disabled = false;
                btn.innerText = "Register for Free";
              }
            } else {
              // --- PAID TICKETS DESIGN ---

              // CRITICAL FIX: Check if structure exists. If not (wiped by Free view), restore it.
              let itemsEl = document.getElementById("breakdownItems");
              if (!itemsEl) {
                // Restore the full HTML structure for paid view
                breakdownContainer.innerHTML = `
                    <div id="breakdownItems"></div>
                    <div class="price-row"><span>Service Fee (5%)</span><span id="feeDisplay"></span></div>
                    
                    <!-- COUPON SECTION -->
                    <div id="couponInputArea" style="margin-top: 15px; border-top: 1px dashed var(--border); padding-top: 10px;">
                      <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="couponCodeInput" placeholder="Promo Code" style="padding: 8px; border-radius: 6px; flex: 1; margin-bottom: 0;" />
                        <button class="btn btn-secondary btn-sm" onclick="app.handlers.applyCoupon()">Apply</button>
                      </div>
                      <div id="couponStatus" style="font-size: 0.8rem; margin-top: 5px;"></div>
                    </div>

                    <div class="price-row total"><span>Total</span><span id="totalDisplay"></span></div>
                  `;

                // Restore Coupon Status if it was applied previously
                if (app.state.appliedCoupon) {
                  const statusEl = document.getElementById("couponStatus");
                  if (statusEl)
                    statusEl.innerHTML = `<span style="color:var(--success)"><i class="ph ph-check-circle"></i> Code applied successfully!</span>`;
                  const inputEl = document.getElementById("couponCodeInput");
                  if (inputEl) inputEl.value = app.state.appliedCoupon.code;
                }

                itemsEl = document.getElementById("breakdownItems");
              }

              // Update Values
              itemsEl.innerHTML = breakdownHTML;

              // Remove old discount rows to prevent duplication
              const oldDiscounts =
                breakdownContainer.querySelectorAll(".discount-row");
              oldDiscounts.forEach((el) => el.remove());

              // Update Fee and Total
              document.getElementById("feeDisplay").innerText = fmtMoney(fee);
              document.getElementById("totalDisplay").innerText =
                fmtMoney(total);

              // Inject Discount HTML
              if (discountHTML) {
                const totalRow =
                  breakdownContainer.querySelector(".price-row.total");
                if (totalRow) {
                  totalRow.insertAdjacentHTML("beforebegin", discountHTML);
                }
              }

              if (btn) {
                btn.disabled = false;
                btn.innerText = `Checkout - ${fmtMoney(total)}`;
              }
            }
          },
          unlockInvite: (ticketId, realPassword) => {
            const input = document.getElementById(`pw-input-${ticketId}`);
            if (!input) return;

            const entered = input.value.trim();

            if (entered !== realPassword) {
              app.ui.showToast("Incorrect password", "error");
              return;
            }

            // ── Important part ───────────────────────────────────────
            const currentUser = app.state.currentUser;
            if (!currentUser || !currentUser.id) {
              app.ui.showToast("Please login first", "error");
              app.ui.openAuthModal("login");
              return;
            }

            app.ui.showToast("Verifying access...", "info");

            // Call backend to record unlock as a "purchase" with qty=0 or special flag
            api
              .post("unlockInviteTicket", {
                event_id: app.state.currentEventId,
                ticket_id: ticketId,
                buyer_id: currentUser.id || currentUser.user_id,
                password: entered, // optional – can be removed
              })
              .then((res) => {
                if (res?.status === "success") {
                  app.ui.showToast("Ticket unlocked!", "success");
                  // Force refresh to show quantity controls
                  app.router.navigate("event", app.state.currentEventId);
                } else {
                  app.ui.showToast(res?.message || "Unlock failed", "error");
                }
              })
              .catch((err) => {
                app.ui.showToast("Connection error", "error");
                console.error(err);
              });
          },

          applyCoupon: () => {
            const input = document.getElementById("couponCodeInput");
            const statusEl = document.getElementById("couponStatus");
            const code = input.value.trim().toUpperCase();

            if (!code) return;

            const coupons = app.state.currentEventData.coupons || [];
            const found = coupons.find((c) => c.code === code);

            if (found) {
              // --- NEW VALIDATION ---

              // 1. Check Expiry
              if (found.expiry) {
                const expDate = new Date(found.expiry);
                expDate.setHours(23, 59, 59, 999); // Check end of day
                if (new Date() > expDate) {
                  statusEl.innerHTML = `<span style="color:var(--danger)"><i class="ph ph-x-circle"></i> This coupon has expired.</span>`;
                  app.state.appliedCoupon = null;
                  app.handlers.updateSummary();
                  return;
                }
              }

              // 2. Check Usage Limit
              if (found.limit > 0 && (found.used || 0) >= found.limit) {
                statusEl.innerHTML = `<span style="color:var(--danger)"><i class="ph ph-x-circle"></i> This coupon has reached its usage limit.</span>`;
                app.state.appliedCoupon = null;
                app.handlers.updateSummary();
                return;
              }

              // --- END VALIDATION ---

              app.state.appliedCoupon = found;
              statusEl.innerHTML = `<span style="color:var(--success)"><i class="ph ph-check-circle"></i> Code applied successfully!</span>`;
              app.ui.showToast("Coupon Applied!");
              app.handlers.updateSummary();
            } else {
              app.state.appliedCoupon = null;
              statusEl.innerHTML = `<span style="color:var(--danger)"><i class="ph ph-x-circle"></i> Invalid code</span>`;
              app.handlers.updateSummary();
            }
          },

          initBuy: () => {
            if (!app.state.currentUser) {
              app.ui.showToast("Please login to continue.", "info");
              app.state.isLoginMode = true;
              app.ui.toggleAuthMode();
              app.ui.openModal("authModal");
              return;
            }

            let hasFree = false;
            let hasPaid = false;
            let subtotal = 0;
            let summaryHTML = "";

            // Generate Summary for Checkout Modal
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => t.ticketId === tid,
                );
                if (ticket) {
                  if (ticket.accessType === "free") hasFree = true;
                  else hasPaid = true;

                  const itemTotal = ticket.price * qty;
                  subtotal += itemTotal;

                  summaryHTML += `
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.95rem;">
                        <span>${ticket.type} <span style="color:var(--text-muted)">x${qty}</span></span>
                        <span>${fmtMoney(itemTotal)}</span>
                    </div>`;
                }
              }
            });

            // Calculate Fee
            let fee = subtotal * app.state.feePercentage;
            let discount = 0;

            // Apply Coupon Discount
            if (app.state.appliedCoupon) {
              const cp = app.state.appliedCoupon;
              if (cp.type === "percent") {
                discount = subtotal * (cp.value / 100);
              } else {
                discount = cp.value;
              }
              if (discount > subtotal) discount = subtotal; // Cap at subtotal

              summaryHTML += `
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.95rem; color: var(--success);">
                    <span>Discount (${cp.code})</span>
                    <span>-${fmtMoney(discount)}</span>
                </div>`;
            }

            let total = subtotal - discount + fee;
            if (total < 0) total = 0; // Ensure no negative total

            summaryHTML += `
                <div style="border-top:1px dashed var(--border); margin:10px 0; padding-top:10px; display:flex; justify-content:space-between; color:var(--text-muted);">
                    <span>Service Fee (5%)</span>
                    <span>${fmtMoney(fee)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:700; font-size:1.1rem; color:var(--text-main);">
                    <span>Total</span>
                    <span>${fmtMoney(total)}</span>
                </div>
            `;

            document.getElementById("checkoutSummary").innerHTML = summaryHTML;

            // FIX: Reset button HTML structure safely
            const payBtn = document.getElementById("payBtn");
            payBtn.innerHTML = `Pay <span id="payAmount"></span>`;
            document.getElementById("payAmount").innerText = fmtMoney(total);

            // Logic to decide payment method
            if (hasPaid || total > 0) {
              // Changed logic to check total > 0
              // Normal Paystack flow
              payBtn.onclick = app.handlers.processPayment;
              payBtn.innerText = `Pay ${fmtMoney(total)}`; // Simpler to just set text
              app.ui.openModal("checkoutModal");
            } else if (hasFree && !hasPaid) {
              // Free flow
              app.handlers.openFreeRegistrationModal();
            }
          },
          openFreeRegistrationModal: () => {
            // 1. First make sure the modal is in the DOM and visible
            app.ui.openModal("checkoutModal");

            // 2. Wait a tiny moment for DOM to settle (or use MutationObserver in production)
            setTimeout(() => {
              const summaryEl = document.getElementById("checkoutSummary");
              const payBtn = document.getElementById("payBtn");
              const payAmountEl = document.getElementById("payAmount");

              if (!summaryEl || !payBtn || !payAmountEl) {
                console.error("Checkout modal elements missing!");
                app.ui.showToast(
                  "Error preparing free registration form",
                  "error",
                );
                return;
              }

              // Now it's safe to update
              let formHTML = `
      <div class="form-group">
        <label>Your Name</label>
        <input type="text" id="freeName" required style="width:100%; padding:12px; border-radius:8px;">
      </div>
      <div class="form-group">
        <label>Phone Number</label>
        <input type="tel" id="freePhone" required style="width:100%; padding:12px; border-radius:8px;">
      </div>
      <small style="color:var(--text-muted); display:block; margin-top:8px;">
        This information may be shared with the organizer for entry management.
      </small>
    `;

              summaryEl.innerHTML = formHTML;
              payBtn.innerText = "Complete Free Registration";

              // Safely clear / hide price
              payAmountEl.innerText = "";
              payAmountEl.style.display = "none"; // ← nicer than empty span

              payBtn.onclick = app.handlers.processFreeRegistration;
            }, 100); // small delay — usually enough
          },
          processFreeRegistration: async () => {
            const btn = document.getElementById("payBtn");
            app.ui.setLoading(btn, true);

            const cartItems = [];
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => t.ticketId === tid,
                );
                cartItems.push({
                  ticket_id: tid,
                  ticket_type: ticket.type,
                  quantity: qty,
                  unit_price: 0,
                  subtotal: 0,
                });
              }
            });

            const res = await api.post("purchase", {
              event_id: app.state.currentEventId,
              buyer_id: app.state.currentUser.id,
              cart: cartItems,
              total_paid: 0,
              subtotal: 0,
              fee: 0,
              custom_data: {
                name: document.getElementById("freeName").value,
                phone: document.getElementById("freePhone").value,
              },
            });

            app.ui.setLoading(btn, false, "Complete Registration");

            if (res && res.status === "success") {
              app.ui.closeModal("checkoutModal");
              app.ui.showToast("Registration Successful!");
              app.router.navigate("dashboard");
            } else {
              app.ui.showToast(res?.message || "Error", "error");
            }
          },
          processPayment: async (e) => {
            if (e) e.preventDefault();

            if (!app.state.currentUser) {
              app.ui.showToast("Please login to purchase.", "info");
              app.ui.closeModal("checkoutModal");
              app.ui.openAuthModal("login");
              return;
            }

            let subtotal = 0;
            const cartItems = [];
            Object.entries(app.state.cart).forEach(([tid, qty]) => {
              if (qty > 0) {
                const ticket = app.state.currentEventData.tickets.find(
                  (t) => String(t.ticketId) == String(tid),
                );
                if (ticket) {
                  const itemTotal = ticket.price * qty;
                  subtotal += itemTotal;
                  cartItems.push({
                    ticket_id: tid,
                    ticket_type: ticket.type,
                    quantity: qty,
                    unit_price: ticket.price,
                    subtotal: itemTotal,
                  });
                }
              }
            });

            if (cartItems.length === 0) {
              app.ui.showToast("Your cart is empty", "error");
              return;
            }

            const fee = subtotal * app.state.feePercentage;

            // Calculate Discount
            let discount = 0;
            if (app.state.appliedCoupon) {
              const cp = app.state.appliedCoupon;
              if (cp.type === "percent") {
                discount = subtotal * (cp.value / 100);
              } else {
                discount = cp.value;
              }
              if (discount > subtotal) discount = subtotal;
            }

            const total = subtotal - discount + fee;
            if (total < 0) total = 0;

            const totalInKobo = Math.round(total * 100);

            const ref = "evt_" + app.state.currentEventId + "_" + Date.now();

            const handler = PaystackPop.setup({
              key: app.state.paystackKey,
              email: app.state.currentUser.email,
              amount: totalInKobo,
              currency: "NGN",
              ref: ref,
              metadata: {
                custom_fields: [
                  {
                    display_name: "Event ID",
                    variable_name: "event_id",
                    value: app.state.currentEventId,
                  },
                  // Optional: Send coupon code to backend for records
                  {
                    display_name: "Coupon Code",
                    variable_name: "coupon_code",
                    value: app.state.appliedCoupon
                      ? app.state.appliedCoupon.code
                      : "",
                  },
                ],
              },
              callback: function (response) {
                app.ui.showToast("Payment successful! Verifying...", "info");
                app.handlers.verifyPaymentOnServer(
                  response.reference,
                  cartItems,
                  total,
                  fee,
                  subtotal,
                );
              },
              onClose: function () {
                app.ui.showToast("Payment window closed.", "info");
              },
            });

            handler.openIframe();
          },
          verifyPaymentOnServer: async (
            reference,
            cartItems,
            total,
            fee,
            subtotal,
          ) => {
            const btn = document.getElementById("payBtn");
            app.ui.setLoading(btn, true);

            // CALCULATION FIX: Determine discount amount
            let discount = 0;
            if (app.state.appliedCoupon) {
              const cp = app.state.appliedCoupon;
              if (cp.type === "percent") {
                discount = subtotal * (cp.value / 100);
              } else {
                discount = cp.value;
              }
            }

            const res = await api.post("verifyPayment", {
              reference: reference,
              event_id: app.state.currentEventId,
              buyer_id:
                app.state.currentUser.id || app.state.currentUser.user_id,
              cart: cartItems,
              total_paid: total,
              service_fee: fee,
              subtotal: subtotal,
              discount: discount, // ADDED THIS LINE
            });

            app.ui.setLoading(btn, false, "Pay Now");
            // ... rest of function remains unchanged

            if (res && res.status === "success") {
              app.ui.closeModal("checkoutModal");
              app.ui.showToast("Payment Verified! Tickets Issued.");
              app.router.navigate("dashboard");
            } else {
              app.ui.showToast(
                res?.message ||
                  "Verification failed. Please contact support with Ref: " +
                    reference,
                "error",
              );
            }
          },
          openEventModal: () => {
            app.state.isEditing = false;
            app.state.editingId = null;
            document.getElementById("modalTitle").innerText = "Create Event";
            document.getElementById("saveEventBtn").innerText = "Publish Event";
            document.getElementById("eventIdHidden").value = "";
            document.getElementById("eventTitle").value = "";
            document.getElementById("eventDate").value = "";
            document.getElementById("eventLocation").value = "";
            document.getElementById("eventDescription").value = "";
            document.getElementById("ticketTypesContainer").innerHTML = "";
            document.getElementById("couponContainer").innerHTML = ""; // Clear coupons
            app.handlers.addTicketRow();
            app.handlers.clearImage();
            app.ui.openModal("eventModal");
          },
          editEvent: async (id) => {
            const res = await api.post("getEvents");
            const event = res.data.find((e) => e.id === id);
            if (!event) return;
            app.state.isEditing = true;
            app.state.editingId = id;
            document.getElementById("modalTitle").innerText = "Edit Event";
            document.getElementById("saveEventBtn").innerText = "Update Event";
            document.getElementById("eventIdHidden").value = id;
            document.getElementById("eventTitle").value = event.title;
            document.getElementById("eventDate").value = event.date;
            document.getElementById("eventLocation").value = event.location;
            document.getElementById("eventDescription").value =
              event.description || "";
            const container = document.getElementById("ticketTypesContainer");
            container.innerHTML = "";
            event.tickets.forEach((t) => app.handlers.addTicketRow(t));

            // Load Coupons
            const couponContainer = document.getElementById("couponContainer");
            couponContainer.innerHTML = "";
            if (event.coupons && event.coupons.length > 0) {
              event.coupons.forEach((c) => app.handlers.addCouponRow(c));
            }

            const img = document.getElementById("imgPreview");
            const previewContainer = document.getElementById(
              "imagePreviewContainer",
            );
            if (event.image) {
              img.src = event.image;
              previewContainer.style.display = "block";
            } else {
              previewContainer.style.display = "none";
            }
            app.ui.openModal("eventModal");
          },
          addTicketRow: (data = null) => {
            const container = document.getElementById("ticketTypesContainer");
            const id = Date.now().toString();
            const ticketId = data ? data.ticketId : "new_" + id;
            const div = document.createElement("div");
            div.className = "ticket-type-row";
            div.style =
              "background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border);";

            const accessType = data ? data.accessType : "paid";
            const password = data ? data.accessPassword : "";
            const fields = data && data.customFields ? data.customFields : [];

            // Note: Removed 'required' from the input below to prevent the "not focusable" error
            div.innerHTML = `
              <input type="hidden" class="t-id" value="${ticketId}" />
              <button type="button" class="remove-ticket-btn" onclick="this.parentElement.remove()" style="float:right; background:none; border:none; color:var(--danger); cursor:pointer;"><i class="ph ph-x"></i></button>
              
              <div class="form-group">
                <label>Ticket Category</label>
                <select class="t-access-type" onchange="app.handlers.handleAccessTypeChange(this)" style="...">
                  <option value="paid" ${accessType === "paid" ? "selected" : ""}>Paid</option>
                  <option value="free" ${accessType === "free" ? "selected" : ""}>Free (Registration)</option>
                  <option value="invite" ${accessType === "invite" ? "selected" : ""}>Invite Only</option>
                  <option value="external" ${accessType === "external" ? "selected" : ""}>External Link (no sale here)</option>
                </select>
              </div>

              <div class="form-group">
                <label>Name</label><input type="text" class="t-name" value="${data ? data.type : ""}" required />
              </div>

              <!-- PAID / INVITE FIELDS -->
              <div class="paid-fields" style="display:${accessType === "free" ? "none" : "block"}">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                  <div><label>Price (₦)</label><input type="number" class="t-price" value="${data ? data.price : ""}" /></div>
                  <div><label>Qty</label><input type="number" class="t-qty" value="${data ? data.qty : ""}" /></div>
                </div>
              </div>

              <!-- FREE FIELDS -->
              <div class="free-fields" style="display:${accessType === "free" ? "block" : "none"}; margin-top:10px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
                   <div><label>Qty</label><input type="number" class="t-qty" value="${data ? data.qty : ""}" /></div>
                   <div></div>
                </div>
                <label style="margin-top:10px; display:block;">Required Info</label>
                <small style="color:var(--text-muted); display:block; margin-bottom:5px;">Check fields attendee must fill</small>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <label style="display:flex; align-items:center; gap:5px; color:var(--text-main)">
                    <input type="checkbox" class="cf-name" ${fields.includes("Name") ? "checked" : ""} /> Name
                  </label>
                  <label style="display:flex; align-items:center; gap:5px; color:var(--text-main)">
                    <input type="checkbox" class="cf-gender" ${fields.includes("Gender") ? "checked" : ""} /> Gender
                  </label>
                  <label style="display:flex; align-items:center; gap:5px; color:var(--text-main)">
                    <input type="checkbox" class="cf-phone" ${fields.includes("Phone") ? "checked" : ""} /> Phone
                  </label>
                </div>
              </div>

              <!-- INVITE ONLY FIELDS -->
              <div class="invite-fields" style="display:${accessType === "invite" ? "block" : "none"}; margin-top:10px;">
                <div class="form-group">
                  <label>Access Password</label>
                  <input type="text" class="t-password" placeholder="Share this with guests" value="${password}" />
                </div>
              </div>

              <!-- EXTERNAL LINK FIELDS -->
              <div class="external-fields" style="display:${accessType === "external" ? "block" : "none"}; margin-top:10px;">
                <div class="form-group">
                  <label>External Ticket Link <span style="color:var(--danger); font-size:0.85rem;">(required for this type)</span></label>
                  <input type="url" class="t-external-link" placeholder="https://eventbrite.com/... or https://your-site.com/tickets" 
                  value="${data && data.externalLink ? data.externalLink : ""}" 
                  />
                  <small style="color:var(--text-muted); display:block; margin-top:6px;">
                    Attendees will be redirected to this link instead of buying here.
                  </small>
                </div>
                <div style="margin-top:12px; color:#f87171; font-size:0.9rem;">
                  <strong>Note:</strong> Price and quantity fields will be ignored for external tickets.
                </div>
              </div>
            `;
            container.appendChild(div);

            // FIX: Trigger the change handler once to set the correct 'required' attributes
            // This adds 'required' if it's external, and leaves it off if it's paid/free
            app.handlers.handleAccessTypeChange(
              div.querySelector(".t-access-type"),
            );
          },
          handleAccessTypeChange: (selectElement) => {
            const row = selectElement.closest(".ticket-type-row");
            const type = selectElement.value;

            // Reset / show-hide sections
            row.querySelector(".paid-fields").style.display =
              type === "paid" || type === "invite" ? "block" : "none";
            row.querySelector(".free-fields").style.display =
              type === "free" ? "block" : "none";
            row.querySelector(".invite-fields").style.display =
              type === "invite" ? "block" : "none";
            row.querySelector(".external-fields").style.display =
              type === "external" ? "block" : "none";

            // Optional: clear price when switching to free/external
            if (type === "free" || type === "external") {
              const priceInput = row.querySelector(".t-price");
              if (priceInput) priceInput.value = "0";
            }

            // Make link required only for external type
            const linkInput = row.querySelector(".t-external-link");
            if (linkInput) {
              if (type === "external") {
                linkInput.setAttribute("required", "");
              } else {
                linkInput.removeAttribute("required");
              }
            }
          },
          addCouponRow: (data = null) => {
            const container = document.getElementById("couponContainer");
            const div = document.createElement("div");
            div.className = "coupon-row";
            div.style =
              "background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border); display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;";

            // FIX: Safe date extraction
            let expiryVal = "";
            if (data && data.expiry) {
              // If backend sends YYYY-MM-DD, use it directly.
              // If it sends a full timestamp, convert it.
              if (data.expiry.length === 10) {
                expiryVal = data.expiry;
              } else {
                expiryVal = new Date(data.expiry).toISOString().split("T")[0];
              }
            }

            div.innerHTML = `
              <button type="button" onclick="this.parentElement.remove()" style="background:none; border:none; color:var(--danger); cursor:pointer; order: 5;"><i class="ph ph-x"></i></button>
              
              <div style="flex: 1; min-width: 120px;">
                <label style="font-size: 0.8rem;">Code</label>
                <input type="text" class="c-code" value="${data ? data.code : ""}" placeholder="SAVE20" style="padding: 8px; width: 100%;" />
              </div>
              
              <div style="width: 80px;">
                <label style="font-size: 0.8rem;">Discount</label>
                <input type="number" class="c-value" value="${data ? data.value : ""}" placeholder="10" style="padding: 8px; width: 100%;" />
              </div>
              
              <div style="width: 80px;">
                <label style="font-size: 0.8rem;">Type</label>
                <select class="c-type" style="padding: 8px; width: 100%;">
                  <option value="percent" ${data && data.type === "percent" ? "selected" : ""}>%</option>
                  <option value="fixed" ${data && data.type === "fixed" ? "selected" : ""}>Fixed</option>
                </select>
              </div>

              <!-- NEW: Expiry Date Input -->
              <div style="flex: 1; min-width: 140px;">
                <label style="font-size: 0.8rem;">Expiry Date</label>
                <input type="date" class="c-expiry" value="${expiryVal}" style="padding: 8px; width: 100%;" />
              </div>

              <!-- NEW: Usage Limit Input -->
              <div style="width: 100px;">
                <label style="font-size: 0.8rem;">Use Limit</label>
                <input type="number" class="c-limit" value="${data ? data.limit : ""}" placeholder="0 = Unlimited" style="padding: 8px; width: 100%;" />
                ${data && data.used ? `<small style="color:var(--text-muted); font-size: 0.7rem; display:block; margin-top:2px;">Used: ${data.used}</small>` : ""}
              </div>
            `;
            container.appendChild(div);
          },
          saveEvent: async (e) => {
            e.preventDefault();
            const btn = document.getElementById("saveEventBtn");
            app.ui.setLoading(btn, true);
            const title = document.getElementById("eventTitle").value.trim();
            const date = document.getElementById("eventDate").value;
            const location = document
              .getElementById("eventLocation")
              .value.trim();
            const description = document
              .getElementById("eventDescription")
              .value.trim();
            const category = document.getElementById("eventCategory").value;
            const fileInput = document.getElementById("eventImageInput");
            if (
              !app.state.currentUser ||
              !(app.state.currentUser.id || app.state.currentUser.user_id)
            ) {
              app.ui.showToast(
                "Session error – please log out and log in again",
                "error",
              );
              app.ui.setLoading(btn, false);
              return;
            }
            const organizerId =
              app.state.currentUser.id || app.state.currentUser.user_id;
            const organizerName =
              app.state.currentUser.organizer_name ||
              app.state.currentUser.name ||
              "Unknown";
            let imagePayload = "";
            if (fileInput.files.length > 0) {
              try {
                imagePayload = await compressImage(fileInput.files[0]);
              } catch (err) {
                console.error(err);
                app.ui.showToast("Failed to process image.", "error");
                app.ui.setLoading(btn, false);
                return;
              }
            } else if (app.state.isEditing) {
              const res = await api.post("getEvents");
              const existingEvent = res.data.find(
                (ev) => ev.id === app.state.editingId,
              );
              if (existingEvent && existingEvent.image) {
                imagePayload = existingEvent.image;
              } else {
                imagePayload = `https://picsum.photos/seed/${title || Date.now()}/400/225`;
              }
            } else {
              imagePayload = `https://picsum.photos/seed/${title || Date.now()}/400/225`;
            }
            const ticketRows = document.querySelectorAll(".ticket-type-row");
            const tickets = Array.from(ticketRows)
              .map((row) => {
                const accessType = row.querySelector(".t-access-type").value;

                let customFields = [];
                if (accessType === "free") {
                  if (row.querySelector(".cf-name")?.checked)
                    customFields.push("Name");
                  if (row.querySelector(".cf-gender")?.checked)
                    customFields.push("Gender");
                  if (row.querySelector(".cf-phone")?.checked)
                    customFields.push("Phone");
                }

                const isExternal = accessType === "external";

                return {
                  ticketId: row.querySelector(".t-id").value,
                  type: row.querySelector(".t-name").value.trim(),
                  price: isExternal
                    ? 0
                    : Number(row.querySelector(".t-price")?.value) || 0,
                  qty: isExternal
                    ? 0
                    : Number(row.querySelector(".t-qty")?.value) || 0,
                  externalLink:
                    row.querySelector(".t-external-link")?.value.trim() || "",
                  accessType: accessType,
                  accessPassword:
                    accessType === "invite"
                      ? row.querySelector(".t-password")?.value || ""
                      : "",
                  customFields: customFields,
                  isExternal: isExternal, // ← helpful flag for frontend/backend
                };
              })
              .filter((t) => t.type); // keep only rows with name
            // Collect Coupons
            const couponRows = document.querySelectorAll(".coupon-row");
            const coupons = Array.from(couponRows)
              .map((row) => {
                return {
                  code: row.querySelector(".c-code").value.trim().toUpperCase(),
                  value: Number(row.querySelector(".c-value").value) || 0,
                  type: row.querySelector(".c-type").value,
                  expiry: row.querySelector(".c-expiry").value || "", // NEW
                  limit: Number(row.querySelector(".c-limit").value) || 0, // NEW
                };
              })
              .filter((c) => c.code && c.value > 0);
            const payload = {
              title,
              date,
              location,
              description,
              category,
              tickets,
              coupons, // Add coupons to payload
              organizer_id: organizerId,
              organizer_name: organizerName,
              imageBase64: imagePayload,
            };
            let res;
            if (app.state.isEditing) {
              payload.event_id = app.state.editingId;
              res = await api.post("updateEvent", payload);
            } else {
              res = await api.post("createEvent", payload);
            }
            app.ui.setLoading(
              btn,
              false,
              app.state.isEditing ? "Update Event" : "Publish Event",
            );
            if (res?.status === "success") {
              localStorage.removeItem("eh_events_cache");
              app.ui.closeModal("eventModal");
              app.ui.showToast(
                app.state.isEditing ? "Event updated!" : "Event published!",
              );
              app.router.navigate("organizer");
            } else {
              app.ui.showToast(res?.message || "Failed to save event", "error");
            }
          },
          previewImage: async (input) => {
            if (input.files && input.files[0]) {
              try {
                const compressedData = await compressImage(input.files[0]);
                const img = document.getElementById("imgPreview");
                const container = document.getElementById(
                  "imagePreviewContainer",
                );
                img.src = compressedData;
                container.style.display = "block";
              } catch (err) {
                console.error(err);
                app.ui.showToast("Error previewing image", "error");
              }
            }
          },
          clearImage: () => {
            const input = document.getElementById("eventImageInput");
            input.value = "";
            document.getElementById("imagePreviewContainer").style.display =
              "none";
          },
          deleteEvent: async (id) => {
            if (!confirm("Delete this event?")) return;
            await api.post("deleteEvent", { eventId: id });
            localStorage.removeItem("eh_events_cache");
            app.router.navigate("organizer");
          },
          openWithdrawalModal: (amount) => {
            document.getElementById("withdrawalAmountInput").value =
              amount.toFixed(2);
            app.ui.openModal("withdrawalModal");
          },
          requestWithdrawal: async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const organizerId =
              app.state.currentUser.id || app.state.currentUser.user_id;
            if (!organizerId) {
              app.ui.showToast("Error: User not identified.", "error");
              return;
            }
            const res = await api.post("requestWithdrawal", {
              organizerId: organizerId,
              amount: fd.get("amount"),
              bankName: fd.get("bankName"),
              accountNum: fd.get("accountNum"),
            });
            if (res) {
              app.ui.closeModal("withdrawalModal");
              app.ui.showToast("Request Sent!");
              app.router.navigate("organizer");
            }
          },
          shareEventLink: (id) => {
            const url = `${window.location.origin}${window.location.pathname}?eventId=${id}`;
            if (navigator.clipboard) {
              navigator.clipboard
                .writeText(url)
                .then(() => {
                  app.ui.showToast("Link copied!");
                })
                .catch((err) => {
                  app.ui.showToast("Failed to copy", "error");
                });
            } else {
              const textArea = document.createElement("textarea");
              textArea.value = url;
              document.body.appendChild(textArea);
              textArea.select();
              try {
                document.execCommand("copy");
                app.ui.showToast("Link copied!");
              } catch (err) {
                app.ui.showToast("Failed to copy", "error");
              }
              document.body.removeChild(textArea);
            }
          },
          openTicketDetail: async (dataStr) => {
            const data = JSON.parse(decodeURIComponent(dataStr));
            app.state.currentTicketData = data;

            // Preload QR as data URL (already working from previous fix)
            let qrDataUrl = "";
            try {
              const response = await fetch(
                `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(data.qrData)}`,
              );
              const blob = await response.blob();
              qrDataUrl = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
              });
            } catch (err) {
              console.error("QR preload failed:", err);
              qrDataUrl = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodeURIComponent(data.qrData)}`;
            }

            const container = document.getElementById("ticketForCapture");

            container.innerHTML = `
    <div class="ticket-visual ticket-visual-large" style="width: 100%; max-width: 600px; margin: 0 auto; background: white; color: #000000 !important;">
      <div class="tv-cutout left"></div>
      <div class="tv-cutout right"></div>
      
      <div class="tv-main" style="color: #000000 !important;">
        <div style="text-align: center; margin-bottom: 20px;">
          <h2 style="font-size: 1.8rem; font-weight: 800; margin: 0; color: #000 !important;">
            EVENT TICKET
          </h2>
        </div>
        
        <h3 style="font-size: 1.6rem; font-weight: 700; margin: 12px 0; color: #000 !important; text-align: center;">
          ${data.title.toUpperCase()}
        </h3>
        
        <div style="font-size: 1.1rem; margin: 8px 0; color: #000 !important;">
          <strong>Date:</strong> ${data.date}
        </div>
        
        <div style="font-size: 1.1rem; margin: 8px 0; color: #000 !important;">
          <strong>Location:</strong> ${data.location || "N/A"}
        </div>
        
        <div style="margin-top: 24px;">
          <div style="font-size: 1rem; font-weight: 600; color: #000 !important;">
            Ticket Type
          </div>
          <div style="font-size: 1.3rem; font-weight: 700; color: #000 !important;">
            ${data.type} × ${data.qty}
          </div>
        </div>
        
        <div style="margin-top: 24px;">
          <div style="font-size: 1rem; font-weight: 600; color: #000 !important;">
            TOTAL PAID
          </div>
          <div style="font-size: 1.8rem; font-weight: 800; color: #000 !important;">
            ${data.total}
          </div>
        </div>
      </div>
      
      <div class="tv-stub" style="color: #000000 !important;">
        <img src="${qrDataUrl}" alt="QR Code" class="tv-qr" crossorigin="anonymous" />
        <div style="font-size: 1rem; font-weight: 600; margin-top: 12px; color: #000 !important;">
          Scan to Enter
        </div>
        <div style="font-size: 0.9rem; margin-top: 6px; color: #000 !important;">
          Order #${data.id.slice(-6)}
        </div>
      </div>
    </div>
  `;

            app.ui.openModal("ticketDetailModal");
          },
          downloadTicket: async () => {
            const element = document.getElementById("ticketForCapture");
            app.ui.showToast("Generating image...", "info");

            try {
              const canvas = await html2canvas(element, {
                scale: 2,
                backgroundColor: "#ffffff",
                useCORS: true, // ← important for external images
                allowTaint: true, // ← allows tainted canvas (may show warning)
                logging: false,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight,
              });

              const link = document.createElement("a");
              link.download = `ticket-${app.state.currentTicketData.id}.png`;
              link.href = canvas.toDataURL("image/png");
              link.click();
            } catch (err) {
              console.error(err);
              app.ui.showToast(
                "Failed to download ticket. Try again.",
                "error",
              );
            }
          },

          shareTicket: async () => {
            const element = document.getElementById("ticketForCapture");
            app.ui.showToast("Preparing share...", "info");

            try {
              const canvas = await html2canvas(element, {
                scale: 2,
                backgroundColor: "#ffffff",
                useCORS: true,
                allowTaint: true,
                logging: false,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight,
              });

              canvas.toBlob(async (blob) => {
                const file = new File(
                  [blob],
                  `ticket-${app.state.currentTicketData.id}.png`,
                  { type: "image/png" },
                );

                if (
                  navigator.share &&
                  navigator.canShare?.({ files: [file] })
                ) {
                  await navigator.share({
                    title: "My Event Ticket",
                    text: `Ticket for ${app.state.currentTicketData.title}`,
                    files: [file],
                  });
                } else {
                  app.ui.showToast(
                    "Sharing not supported on this device. Download instead.",
                    "info",
                  );
                }
              }, "image/png");
            } catch (err) {
              console.error(err);
              app.ui.showToast("Failed to prepare share image.", "error");
            }
          },
          changePassword: async (e) => {
            e.preventDefault();
            const form = e.target;
            const oldPass = form.oldPassword.value;
            const newPass = form.newPassword.value;
            const confPass = form.confirmPassword.value;

            if (newPass !== confPass) {
              app.ui.showToast("Passwords do not match.", "error");
              return;
            }
            if (newPass.length < 4) {
              app.ui.showToast("Password too short.", "error");
              return;
            }

            const res = await api.post("changePassword", {
              userId: app.state.currentUser.id || app.state.currentUser.user_id,
              oldPassword: oldPass,
              newPassword: newPass,
            });

            if (res && res.status === "success") {
              app.ui.showToast("Password updated successfully!");
              app.ui.closeModal("changePasswordModal");
              form.reset();
            }
          },
        },
        auth: {
          handleAuth: async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const endpoint = app.state.isLoginMode ? "login" : "register";
            let payload = Object.fromEntries(fd.entries());
            if (payload.email)
              payload.email = payload.email.trim().toLowerCase();
            if (payload.password) payload.password = payload.password.trim();
            if (!app.state.isLoginMode) {
              if (!payload.role) payload.role = "attendee";
              payload.organizer_name = payload.brandName || "";
              delete payload.brandName;
            } else {
              payload = {
                email: payload.email,
                password: payload.password,
                username: payload.email,
              };
            }
            const res = await api.post(endpoint, payload);
            if (res && res.status === "success" && res.user) {
              const normalizedUser = {
                ...res.user,
                id: res.user.id || res.user.user_id || String(Date.now()),
              };
              if (normalizedUser.password) delete normalizedUser.password;
              app.state.currentUser = normalizedUser;
              localStorage.setItem(
                "eh_session",
                JSON.stringify(normalizedUser),
              );
              app.ui.closeModal("authModal");
              app.ui.checkSession();
              const hasItemsInCart = Object.values(app.state.cart).some(
                (qty) => qty > 0,
              );
              if (hasItemsInCart && app.state.currentEventId) {
                app.ui.showToast("Account created! Proceeding to checkout...");
                app.ui.openModal("checkoutModal");
              } else {
                if (normalizedUser.role === "organizer") {
                  app.router.navigate("organizer");
                } else {
                  app.router.navigate("home");
                }
              }
              app.ui.showToast(
                "Welcome back, " + (normalizedUser.name || "User") + "!",
              );
            } else {
              app.ui.showToast(
                res?.message || "Login / registration failed",
                "error",
              );
            }
          },
          logout: () => {
            localStorage.removeItem("eh_session");
            localStorage.removeItem("eh_user_profile");
            app.state.currentUser = null;
            window.location.reload();
          },
        },
        ui: {
          setLoading: (btn, isLoading, originalText = "") => {
            if (isLoading) {
              btn.disabled = true;
              btn.innerHTML = `<span class="spinner"></span> Loading...`;
            } else {
              btn.disabled = false;
              btn.innerHTML =
                originalText || btn.dataset.originalText || "Submit";
            }
          },
          openModal: (id) => document.getElementById(id).classList.add("open"),
          closeModal: (id) =>
            document.getElementById(id).classList.remove("open"),
          openAuthModal: (mode = "login") => {
            app.state.isLoginMode = mode === "login";
            app.ui.toggleAuthMode();
            app.ui.openModal("authModal");
          },
          toggleAuthMode: () => {
            app.state.isLoginMode = !app.state.isLoginMode;
            const isLogin = app.state.isLoginMode;
            document.getElementById("authTitle").innerText = isLogin
              ? "Login"
              : "Sign Up";
            document.getElementById("signupFields").style.display = isLogin
              ? "none"
              : "block";
            document.querySelector("#authForm button").innerText = isLogin
              ? "Login"
              : "Sign Up";
            const nameInput = document.querySelector('input[name="name"]');
            if (nameInput) {
              if (isLogin) nameInput.removeAttribute("required");
              else nameInput.setAttribute("required", "");
            }
            if (isLogin) {
              document.getElementById("brandNameGroup").style.display = "none";
            } else {
              const radios = document.getElementsByName("role");
              let isOrg = false;
              for (let r of radios) {
                if (r.checked && r.value === "organizer") isOrg = true;
              }
              document.getElementById("brandNameGroup").style.display = isOrg
                ? "block"
                : "none";
            }
          },
          toggleBrandName: (show) => {
            const el = document.getElementById("brandNameGroup");
            el.style.display = show ? "block" : "none";
          },
          toggleUserMenu: () => {
            const menu = document.getElementById("userMenuDropdown");
            menu.classList.toggle("open");
          },
          showContactUs: () => {
            app.ui.closeModal("userMenuDropdown");
            app.ui.openModal("contactModal");
          },

          openProfileModal: () => {
            const user = app.state.currentUser;
            const profileContent =
              document.getElementById("profileMenuContent");
            const nameEl = document.getElementById("profileNameDisplay");
            const emailEl = document.getElementById("profileEmailDisplay");

            if (user) {
              nameEl.innerText = user.name || "User";
              emailEl.innerText = user.email || "";

              profileContent.innerHTML = `
                    <div class="profile-menu-item" onclick="app.ui.openEditProfileActions()"><i class="ph ph-user-circle"></i> Manage Profile</div>
                    <div class="profile-menu-item" onclick="app.ui.openModal('changePasswordModal')"><i class="ph ph-shield-check"></i> Password & Security</div>
                    ${user.role === "organizer" ? '<div class="profile-menu-item"><i class="ph ph-bell"></i> Notifications <div style="margin-left:auto"><label class="switch"><input type="checkbox" checked onchange="app.ui.showToast(\'Notifications Enabled\')"><span class="slider round"></span></label></div></div>' : ""}
                    <div class="profile-menu-item" onclick="app.ui.showToast('Coming Soon')"><i class="ph ph-globe"></i> Language</div>
                    <div class="profile-menu-item" onclick="app.ui.openModal('aboutModal')"><i class="ph ph-info"></i> About Us</div>
                    <div class="profile-menu-item" onclick="app.ui.openThemePicker()"><i class="ph ph-palette"></i> Theme</div>
                    <div class="profile-menu-item" onclick="app.ui.openModal('helpModal')"><i class="ph ph-question"></i> Help Center</div>
                    <div class="profile-menu-item" onclick="app.ui.showContactUs()"><i class="ph ph-envelope"></i> Contact Us</div>
                    <div class="profile-menu-item danger" onclick="app.auth.logout()"><i class="ph ph-sign-out"></i> Logout</div>
                `;
            } else {
              nameEl.innerText = "Guest";
              emailEl.innerText = "Login to continue";
              profileContent.innerHTML = `
                    <div style="padding: 20px;">
                        <button class="btn btn-primary" style="width: 100%; margin-bottom: 12px;" onclick="app.ui.closeModal('profileModal'); app.ui.openAuthModal('login')">Login</button>
                        <button class="btn btn-secondary" style="width: 100%; margin-bottom: 20px;" onclick="app.ui.closeModal('profileModal'); app.ui.openAuthModal('signup')">Create Account</button>
                        <hr style="border-color: var(--border); margin: 20px 0;">
                        <div class="profile-menu-item" onclick="app.ui.openModal('aboutModal')"><i class="ph ph-info"></i> About Us</div>
                        <div class="profile-menu-item" onclick="app.ui.openModal('helpModal')"><i class="ph ph-question"></i> Help Center</div>
                        <div class="profile-menu-item" onclick="app.ui.showContactUs()"><i class="ph ph-envelope"></i> Contact Us</div>
                    </div>
                `;
            }
            app.ui.openModal("profileModal");
          },

          openEditProfileActions: () => {
            app.ui.triggerProfilePicUpload();
            app.ui.showToast("Select a new profile picture");
          },

          triggerProfilePicUpload: () => {
            document.getElementById("profilePicInput").click();
          },

          handleProfilePicChange: async (input) => {
            if (input.files && input.files[0]) {
              try {
                const compressed = await compressImage(input.files[0]);
                const profile = app.state.userProfile || {};
                profile.pic = compressed;
                app.state.userProfile = profile;
                localStorage.setItem(
                  "eh_user_profile",
                  JSON.stringify(profile),
                );
                app.ui.loadProfilePic();
                app.ui.showToast("Profile picture updated!");
              } catch (e) {
                console.error(e);
              }
            }
          },

          loadProfilePic: () => {
            const profile = app.state.userProfile || {};
            const pic = profile.pic;
            const headerImg = document.getElementById("mobileHeaderProfile");
            const largeImg = document.getElementById("profilePicLarge");
            const placeholder = document.getElementById(
              "profilePicPlaceholder",
            );

            if (pic) {
              headerImg.innerHTML = `<img src="${pic}" />`;
              if (largeImg) {
                largeImg.src = pic;
                largeImg.style.display = "block";
                if (placeholder) placeholder.style.display = "none";
              }
            } else {
              headerImg.innerHTML = `<i class="ph ph-user" style="font-size: 1.2rem; color: white;"></i>`;
              if (largeImg) {
                largeImg.style.display = "none";
                if (placeholder) placeholder.style.display = "block";
              }
            }

            const currentUserId = app.state.currentUser
              ? String(
                  app.state.currentUser.id || app.state.currentUser.user_id,
                )
              : null;
            if (
              app.state.currentEventData &&
              String(app.state.currentEventData.organizerId) === currentUserId
            ) {
              const orgAvatars = document.querySelectorAll(".org-avatar");
              orgAvatars.forEach((el) => {
                el.innerHTML = `<img src="${pic}" />`;
              });
            }
          },

          openThemePicker: () => {
            document.getElementById("themeInput").click();
          },

          handleThemeUpload: async (input) => {
            if (input.files && input.files[0]) {
              try {
                app.ui.showToast("Applying theme...", "info");
                const bgData = await compressBgImage(input.files[0]);
                localStorage.setItem("eh_custom_bg", bgData);
                app.state.customBg = bgData;
                app.ui.applyCustomTheme();
                app.ui.showToast("Theme updated!");
              } catch (e) {
                console.error(e);
                app.ui.showToast("Error setting theme", "error");
              }
            }
          },

          applyCustomTheme: () => {
            const bg = app.state.customBg;
            if (bg) {
              document.body.style.setProperty("--user-bg-image", `url(${bg})`);
              document.body.classList.add("custom-bg");
            } else {
              document.body.classList.remove("custom-bg");
              document.body.style.removeProperty("--user-bg-image");
            }
          },

          checkSession: () => {
            const user = app.state.currentUser;
            if (user) {
              if (!user.id && user.user_id) {
                user.id = user.user_id;
              }
              document.getElementById("loggedOutNav").style.display = "none";
              document.getElementById("loggedInNav").style.display = "flex";
              document.getElementById("userNameDisplay").innerText = user.name;
              const roleBtn = document.getElementById("roleBtn");
              const mobileDash = document.getElementById("mobileDashBtn");
              const mobileTickets = document.getElementById("mobileTicketsBtn");
              const mobileProfile = document.getElementById("mobileProfileBtn");
              mobileTickets.onclick = () => app.router.navigate("dashboard");
              if (user.role === "organizer") {
                roleBtn.innerText = "Organizer Panel";
                roleBtn.onclick = () => app.router.navigate("organizer");
                mobileDash.onclick = () => app.router.navigate("organizer");
                mobileDash.style.display = "flex";
              } else {
                roleBtn.style.display = "none";
                mobileDash.style.display = "none";
              }
            }
            app.ui.loadProfilePic();
          },
          updateMobileNav: (view) => {
            document
              .querySelectorAll(".mobile-nav-item")
              .forEach((el) => el.classList.remove("active"));
            if (view === "home")
              document
                .querySelectorAll(".mobile-nav-item")[0]
                .classList.add("active");
            else if (view === "favorites")
              document
                .querySelectorAll(".mobile-nav-item")[1]
                .classList.add("active");
            else if (view === "dashboard")
              document
                .getElementById("mobileTicketsBtn")
                .classList.add("active");
            else if (view === "organizer")
              document.getElementById("mobileDashBtn").classList.add("active");
          },
          showToast: (msg, type = "success") => {
            const c = document.getElementById("toast-container");
            const t = document.createElement("div");
            t.className = `toast ${type}`;
            t.innerHTML = `<i class="ph ${type === "error" ? "ph-warning" : "ph-check"}"></i><span>${msg}</span>`;
            c.appendChild(t);
            setTimeout(() => t.classList.add("show"), 50);
            setTimeout(() => {
              t.classList.remove("show");
              setTimeout(() => t.remove(), 400);
            }, 3000);
          },
        },
        chat: {
          adminId: "ADMIN_PLATFORM",
          isOpen: false,
          poller: null,
          badgePoller: null, // NEW

          toggle: async function () {
            this.isOpen = !this.isOpen;
            const win = document.getElementById("organizerChatWindow");
            win.classList.toggle("open", this.isOpen);

            if (this.isOpen) {
              // Hide badge immediately
              document.getElementById("orgChatBadge").style.display = "none";

              if (!app.state.currentUser) {
                app.ui.showToast("Login to chat", "info");
                this.isOpen = false;
                win.classList.remove("open");
                app.ui.openAuthModal("login");
                return;
              }

              // Initialize
              document.getElementById("orgChatFooter").style.display = "flex";
              document.getElementById("orgChatBody").innerHTML =
                `<div style="padding:20px; text-align:center; color:var(--text-muted)">Loading...</div>`;
              await this.load();

              // Start message polling
              if (!this.poller)
                this.poller = setInterval(() => this.load(), 4000);

              // Stop badge polling
              if (this.badgePoller) {
                clearInterval(this.badgePoller);
                this.badgePoller = null;
              }
            } else {
              if (this.poller) {
                clearInterval(this.poller);
                this.poller = null;
              }
              // Restart badge polling
              this.startBadgePolling();
            }
          },

          // NEW: Check unread count
          checkUnread: async function () {
            if (this.isOpen) return;
            if (!app.state.currentUser) return;

            const uid =
              app.state.currentUser.id || app.state.currentUser.user_id;
            const res = await api.post("getUnreadCount", { userId: uid });

            if (res.status === "success" && res.count > 0) {
              const badge = document.getElementById("orgChatBadge");
              badge.innerText = res.count > 9 ? "9+" : res.count;
              badge.style.display = "flex";
            } else {
              document.getElementById("orgChatBadge").style.display = "none";
            }
          },

          // NEW: Start badge polling
          startBadgePolling: function () {
            this.checkUnread();
            if (!this.badgePoller) {
              this.badgePoller = setInterval(() => this.checkUnread(), 6000); // Check every 6s
            }
          },

          load: async function () {
            // ... (Keep existing load code) ...
            if (!this.isOpen) return;
            const uid =
              app.state.currentUser.id || app.state.currentUser.user_id;
            const res = await api.post("getMessages", {
              userId: uid,
              otherId: this.adminId,
            });
            if (res.status === "success") {
              const html = res.data
                .map((m) => {
                  const isMine = String(m.sender_id) === String(uid);
                  const time = new Date(m.timestamp).toLocaleTimeString([], {
                    hour: "2-digit",
                    minute: "2-digit",
                  });
                  return `<div class="chat-msg ${isMine ? "sent" : "received"}">${m.message_text}<small style="display:block; opacity:0.6; font-size:0.7rem; margin-top:2px; text-align:${isMine ? "right" : "left"}">${time}</small></div>`;
                })
                .join("");
              const body = document.getElementById("orgChatBody");
              body.innerHTML =
                html ||
                `<div style="text-align:center; padding:30px; color:var(--text-muted)">No messages yet.</div>`;
              if (body.scrollHeight > body.clientHeight)
                body.scrollTop = body.scrollHeight;
            }
          },

          send: async function () {
            // ... (Keep existing send code) ...
            const input = document.getElementById("orgChatInput");
            const msg = input.value.trim();
            if (!msg) return;
            input.value = "";
            input.style.height = "auto";
            const uid =
              app.state.currentUser.id || app.state.currentUser.user_id;
            const name = app.state.currentUser.name;
            await api.post("sendMessage", {
              senderId: uid,
              senderName: name,
              receiverId: this.adminId,
              message: msg,
            });
            await this.load();
          },
        },
      };
      document.addEventListener("DOMContentLoaded", app.init);
    </script>
  </body>
</html>
